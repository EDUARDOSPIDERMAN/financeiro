<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0a0f0d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Financeiro üíö">
<meta name="mobile-web-app-capable" content="yes">
<meta name="description" content="Controle financeiro do casal Eduardo & Juliana">
<link rel="manifest" href="manifest.json">
<!-- √çcone para iOS (tela inicial) -->
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='%230a0f0d'/><text y='.9em' font-size='80' x='10'>üíö</text></svg>">
<title>üíö Eduardo & Juliana</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<!-- Firebase SDKs (compat - funciona em celular sem problemas) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script>
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyByF-OL5O1yrcs7I-6m_GmMT1kghpopQVk",
  authDomain: "financeiro-casal-3d3a3.firebaseapp.com",
  databaseURL: "https://financeiro-casal-3d3a3-default-rtdb.firebaseio.com",
  projectId: "financeiro-casal-3d3a3",
  storageBucket: "financeiro-casal-3d3a3.firebasestorage.app",
  messagingSenderId: "1009995404079",
  appId: "1:1009995404079:web:820343659a89168b8f47da",
  measurementId: "G-9GW9HLQSPG"
};

window._firebaseReady = false;
window._db = null;

function tryInitFirebase() {
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.database();
    window._db = db;
    window._firebaseReady = true;
    console.log('üî• Firebase conectado!');

    // Sync transactions in real time
    db.ref('transactions').on('value', (snap) => {
      const data = snap.val();
      if (data) {
        const incoming = Object.entries(data).map(([k,v]) => ({...v, fbId:k}));
        if (window._syncFromFirebase) window._syncFromFirebase(incoming);
      } else {
        if (window._syncFromFirebase) window._syncFromFirebase([]);
      }
    });

    // Listen for MacroDroid pushes (lan√ßamentos autom√°ticos do Inter)
    db.ref('macrodroid_push').on('child_added', (snap) => {
      const data = snap.val();
      if (!data || data.processed) return;
      db.ref('macrodroid_push/' + snap.key).update({processed: true});
      if (window._processMacroDroidPush) window._processMacroDroidPush(data);
    });

    // ===== LISTENER MACRODROID / TASKER =====
    db.ref('tasker_queue').on('child_added', (snap) => {
      const data = snap.val();
      if (!data || data.processed) return;
      // Marca como processado imediatamente (evita duplicatas)
      db.ref('tasker_queue/' + snap.key).update({processed: true});
      // Processa: mostra modal de review com auto-import em 15s
      if (window._processTaskerEntry) window._processTaskerEntry(data, snap.key);
    });

    // Listen for notifications
    db.ref('notifications').on('value', (snap) => {
      const data = snap.val();
      if (!data) return;
      Object.entries(data).forEach(([id, n]) => {
        if (n.to === window._currentUser && !n.seen) {
          if (window._showNotifBanner) window._showNotifBanner(n.msg, n.from);
          db.ref('notifications/' + id).update({seen: true});
        }
      });
    });

    // Update UI
    const el = document.getElementById('sync-status');
    if (el) { el.textContent = 'üü¢ Firebase conectado'; el.style.color = 'var(--green)'; }
    const dt = document.getElementById('sync-dot-text');
    if (dt) dt.textContent = 'Tempo real ¬∑ Firebase';

  } catch(e) {
    console.error('Firebase erro:', e);
    window._firebaseReady = false;
  }
}

window._pushToFirebase = async function(tx) {
  if (!window._firebaseReady) return null;
  try {
    const ref = await window._db.ref('transactions').push({...tx, syncedAt: Date.now()});
    return ref.key;
  } catch(e) { console.error(e); return null; }
};

window._removeFromFirebase = async function(fbId) {
  if (!window._firebaseReady || !fbId) return;
  try { await window._db.ref('transactions/' + fbId).remove(); } catch(e) {}
};

window._updateInFirebase = async function(fbId, data) {
  if (!window._firebaseReady || !fbId) return;
  try { await window._db.ref('transactions/' + fbId).update(data); } catch(e) {}
};

window._sendNotification = async function(to, msg, from) {
  if (!window._firebaseReady) return;
  try { await window._db.ref('notifications').push({to, msg, from, seen: false, ts: Date.now()}); } catch(e) {}
};

// Init after DOM ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', tryInitFirebase);
} else {
  tryInitFirebase();
}
</script>
<style>
:root{--bg:#0a0f0d;--bg2:#111a14;--bg3:#182019;--card:#1a2b1d;--card2:#1f3323;--green:#2ecc71;--green2:#27ae60;--green-light:#a8f5c3;--green-glow:rgba(46,204,113,0.15);--red:#e74c3c;--red-light:#fca5a5;--yellow:#f1c40f;--blue:#3498db;--orange:#e67e22;--text:#e8f5eb;--text2:#8fb898;--text3:#5a7a60;--border:rgba(46,204,113,0.12);--border2:rgba(46,204,113,0.25);--radius:16px;--shadow:0 8px 32px rgba(0,0,0,0.4);}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;max-width:430px;margin:0 auto;overflow-x:hidden;}
body::before{content:'';position:fixed;top:-200px;left:-200px;width:600px;height:600px;background:radial-gradient(circle,rgba(46,204,113,0.07),transparent 70%);pointer-events:none;z-index:0;}
.screen{display:none;flex-direction:column;min-height:100vh;position:relative;z-index:1;}
.screen.active{display:flex;}
#login-inner{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;gap:32px;min-height:100vh;}
.logo-icon{font-size:64px;display:block;margin-bottom:16px;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.logo-title{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--green),var(--green-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.logo-sub{color:var(--text2);font-size:14px;margin-top:6px;}
.login-card{background:var(--card);border:1px solid var(--border2);border-radius:24px;padding:28px 24px;width:100%;box-shadow:var(--shadow),0 0 60px rgba(46,204,113,0.05);}
.login-card h2{font-size:18px;font-weight:700;margin-bottom:20px;}
.user-selector{display:flex;gap:12px;margin-bottom:24px;}
.user-btn{flex:1;padding:14px 8px;border-radius:12px;border:2px solid var(--border);background:var(--bg3);color:var(--text2);font-family:'Sora',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;text-align:center;}
.user-btn.selected{border-color:var(--green);background:var(--green-glow);color:var(--green-light);}
.user-btn .avatar{font-size:28px;display:block;margin-bottom:6px;}
.btn-primary{width:100%;padding:16px;background:linear-gradient(135deg,var(--green2),var(--green));color:#0a0f0d;font-family:'Sora',sans-serif;font-size:16px;font-weight:700;border:none;border-radius:12px;cursor:pointer;transition:all .2s;box-shadow:0 4px 20px rgba(46,204,113,0.3);}
.btn-primary:active{transform:scale(0.98);}
.btn-secondary{background:var(--card);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:10px;cursor:pointer;font-family:'Sora',sans-serif;font-size:13px;}
.btn-danger{background:rgba(231,76,60,0.12);border:1px solid rgba(231,76,60,0.3);color:var(--red-light);padding:13px 16px;border-radius:10px;cursor:pointer;font-family:'Sora',sans-serif;font-size:14px;font-weight:600;width:100%;}
.header{display:flex;align-items:center;justify-content:space-between;padding:20px 20px 12px;background:var(--bg);position:sticky;top:0;z-index:100;border-bottom:1px solid var(--border);}
.header-left h1{font-size:20px;font-weight:800;}
.header-left p{font-size:12px;color:var(--text2);margin-top:2px;}
.header-right{display:flex;gap:8px;align-items:center;}
.month-nav{display:flex;align-items:center;gap:6px;}
.month-nav button{background:var(--card);border:1px solid var(--border);color:var(--text2);width:28px;height:28px;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;}
.month-nav span{font-size:12px;font-weight:600;color:var(--text);min-width:72px;text-align:center;}
.avatar-badge{width:38px;height:38px;border-radius:50%;background:var(--green-glow);border:2px solid var(--green);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;}
.content{flex:1;padding:16px 16px 100px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.balance-card{background:linear-gradient(135deg,var(--card2),var(--card));border:1px solid var(--border2);border-radius:24px;padding:24px;margin-bottom:16px;position:relative;overflow:hidden;box-shadow:var(--shadow);}
.balance-card::after{content:'';position:absolute;top:-40px;right:-40px;width:150px;height:150px;background:radial-gradient(circle,rgba(46,204,113,0.12),transparent 70%);}
.balance-label{font-size:12px;color:var(--text2);font-weight:500;letter-spacing:.5px;text-transform:uppercase;}
.balance-value{font-size:36px;font-weight:800;font-family:'JetBrains Mono',monospace;margin:8px 0 4px;background:linear-gradient(135deg,#fff,var(--green-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.balance-limit-row{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
.balance-limit-badge{font-size:11px;color:var(--text3);background:rgba(0,0,0,0.3);padding:3px 8px;border-radius:99px;}
.limit-pct{font-size:11px;font-weight:700;padding:3px 8px;border-radius:99px;}
.limit-ok{background:rgba(46,204,113,0.15);color:var(--green);}
.limit-warn{background:rgba(241,196,15,0.15);color:var(--yellow);}
.limit-danger{background:rgba(231,76,60,0.15);color:var(--red-light);}
.limit-bar-bg{height:5px;background:rgba(255,255,255,0.06);border-radius:99px;overflow:hidden;margin-bottom:14px;}
.limit-bar-fill{height:100%;border-radius:99px;transition:width .8s ease;}
.balance-row{display:flex;gap:16px;}
.balance-item{flex:1;background:rgba(0,0,0,0.2);border-radius:12px;padding:10px 12px;}
.balance-item-label{font-size:11px;color:var(--text3);}
.balance-item-value{font-size:16px;font-weight:700;font-family:'JetBrains Mono',monospace;margin-top:3px;}
.income-val{color:var(--green);}
.expense-val{color:var(--red-light);}
.limit-edit-row{display:flex;align-items:center;gap:6px;margin-top:12px;}
.limit-edit-row input{flex:1;background:rgba(0,0,0,0.3);border:1px solid var(--border2);border-radius:8px;padding:8px 10px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:14px;outline:none;}
.limit-edit-row button{background:var(--green2);border:none;color:#0a0f0d;padding:8px 14px;border-radius:8px;cursor:pointer;font-family:'Sora',sans-serif;font-size:13px;font-weight:700;white-space:nowrap;}
.quick-actions{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:20px;}
.qa-btn{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px 4px;text-align:center;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:5px;}
.qa-btn:active{transform:scale(0.95);background:var(--card2);}
.qa-btn .icon{font-size:20px;}
.qa-btn span{font-size:9px;color:var(--text2);font-weight:600;}
.section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.section-title h3{font-size:16px;font-weight:700;}
.budget-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:8px;}
.budget-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.budget-cat{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;}
.budget-vals{font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace;}
.budget-bar-bg{height:7px;background:rgba(255,255,255,0.06);border-radius:99px;overflow:hidden;}
.budget-bar-fill{height:100%;border-radius:99px;transition:width .8s ease;}
.tx-item{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:13px 14px;margin-bottom:8px;display:flex;align-items:center;gap:11px;}
.tx-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0;}
.tx-info{flex:1;min-width:0;}
.tx-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tx-meta{font-size:11px;color:var(--text2);margin-top:2px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
.tx-badge{font-size:10px;background:var(--green-glow);color:var(--green);padding:2px 6px;border-radius:99px;white-space:nowrap;}
.tx-amount{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;white-space:nowrap;}
.tx-amount.income{color:var(--green);}
.tx-amount.expense{color:var(--red-light);}
.chip{display:inline-block;font-size:10px;padding:2px 7px;border-radius:99px;font-weight:600;}
.chip-inter{background:rgba(255,138,0,0.15);color:#ff8a00;}
.chip-pet{background:rgba(52,152,219,0.15);color:#3498db;}
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(10,15,13,0.96);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;padding:8px 0 calc(20px + env(safe-area-inset-bottom));z-index:200;}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 2px;background:none;border:none;cursor:pointer;}
.nav-btn .nav-icon{font-size:21px;}
.nav-btn span{font-size:9px;color:var(--text3);font-family:'Sora',sans-serif;font-weight:600;}
.nav-btn.active span{color:var(--green);}
.nav-btn.active .nav-icon{filter:drop-shadow(0 0 6px var(--green));}
.nav-add{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--green2),var(--green));border:none;font-size:24px;cursor:pointer;box-shadow:0 4px 20px rgba(46,204,113,0.4);display:flex;align-items:center;justify-content:center;margin-top:-14px;transition:all .2s;}
.nav-add:active{transform:scale(0.92);}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(8px);z-index:300;align-items:flex-end;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:28px 28px 0 0;padding:24px;width:100%;max-width:430px;max-height:92vh;overflow-y:auto;animation:slideUp .3s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:40px;height:4px;background:var(--border2);border-radius:99px;margin:0 auto 20px;}
.modal h2{font-size:20px;font-weight:800;margin-bottom:20px;}
.type-toggle{display:flex;background:var(--bg3);border-radius:12px;padding:4px;margin-bottom:20px;}
.type-btn{flex:1;padding:10px;border:none;background:none;border-radius:9px;font-family:'Sora',sans-serif;font-size:14px;font-weight:600;cursor:pointer;color:var(--text2);transition:all .2s;}
.type-btn.active-income{background:rgba(46,204,113,0.2);color:var(--green);}
.type-btn.active-expense{background:rgba(231,76,60,0.2);color:var(--red-light);}
.form-group{margin-bottom:16px;}
.form-label{font-size:11px;color:var(--text2);font-weight:700;letter-spacing:.6px;text-transform:uppercase;margin-bottom:8px;display:block;}
.form-input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:14px 16px;color:var(--text);font-family:'Sora',sans-serif;font-size:15px;outline:none;transition:border-color .2s;}
.form-input:focus{border-color:var(--green);}
.form-input.big{font-size:28px;font-family:'JetBrains Mono',monospace;font-weight:700;}
select.form-input{appearance:none;}
.cat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;}
.cat-option{padding:9px 3px;border-radius:10px;border:2px solid var(--border);background:var(--bg3);text-align:center;cursor:pointer;transition:all .2s;font-size:10px;color:var(--text2);}
.cat-option .cat-em{font-size:19px;display:block;margin-bottom:3px;}
.cat-option.selected{border-color:var(--green);background:var(--green-glow);color:var(--green-light);}
.pet-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:20px;margin-bottom:12px;}
.pet-header{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.pet-avatar{font-size:38px;}
.pet-name-text{font-size:18px;font-weight:700;}
.pet-total{font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace;}
.pet-note{font-size:11px;color:var(--orange);background:rgba(230,126,34,0.1);border:1px solid rgba(230,126,34,0.2);border-radius:8px;padding:7px 10px;margin-bottom:10px;}
.pet-exp-item{display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:var(--bg3);border-radius:10px;margin-bottom:5px;}
.pet-exp-name{font-size:13px;}
.pet-exp-val{font-size:13px;font-family:'JetBrains Mono',monospace;color:var(--red-light);font-weight:600;}
.credit-card-visual{background:linear-gradient(135deg,#1a3a2a,#0d2218);border:1px solid var(--border2);border-radius:20px;padding:24px;margin-bottom:16px;position:relative;overflow:hidden;}
.credit-card-visual::before{content:'';position:absolute;top:-30px;right:-30px;width:120px;height:120px;background:radial-gradient(circle,rgba(46,204,113,0.15),transparent 70%);}
.cc-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;}
.cc-limit{font-size:32px;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--text);margin:6px 0;}
.cc-used{font-size:14px;color:var(--red-light);}
.cc-bar-bg{height:6px;background:rgba(255,255,255,0.08);border-radius:99px;margin:12px 0;overflow:hidden;}
.cc-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--green),var(--yellow));transition:width .8s;}
.cc-free{font-size:13px;color:var(--green);font-weight:600;}
.upload-area{border:2px dashed var(--border2);border-radius:16px;padding:26px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:16px;}
.upload-area:hover{border-color:var(--green);background:var(--green-glow);}
.upload-icon{font-size:34px;margin-bottom:8px;}
.upload-text{font-size:14px;color:var(--text2);font-weight:600;}
.upload-sub{font-size:12px;color:var(--text3);margin-top:4px;}
.invoice-result{background:var(--card);border:1px solid var(--green);border-radius:16px;padding:16px;margin-bottom:16px;display:none;}
.invoice-result h4{color:var(--green);font-size:15px;margin-bottom:12px;}
.invoice-item-row{display:flex;align-items:center;padding:8px 10px;background:var(--bg3);border-radius:8px;margin-bottom:5px;gap:6px;}
.invoice-item-row .iname{font-size:13px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.invoice-item-row .icat{font-size:10px;color:var(--green);background:var(--green-glow);padding:2px 6px;border-radius:99px;white-space:nowrap;flex-shrink:0;}
.invoice-item-row .icat.unknown{color:var(--yellow);background:rgba(241,196,15,0.12);}
.invoice-item-row .ival{font-size:13px;font-family:'JetBrains Mono',monospace;color:var(--red-light);font-weight:600;white-space:nowrap;flex-shrink:0;}
.invoice-import-btn{width:100%;margin-top:10px;padding:13px;background:var(--green2);border:none;border-radius:10px;color:#0a0f0d;font-family:'Sora',sans-serif;font-size:14px;font-weight:700;cursor:pointer;}
.ai-thinking-box{display:none;flex-direction:row;align-items:center;gap:10px;padding:16px;background:var(--card);border-radius:12px;margin-bottom:12px;}
.ai-dots span{display:inline-block;width:6px;height:6px;background:var(--green);border-radius:50%;margin:0 2px;animation:dot-bounce .8s infinite;}
.ai-dots span:nth-child(2){animation-delay:.15s;}
.ai-dots span:nth-child(3){animation-delay:.3s;}
@keyframes dot-bounce{0%,80%,100%{transform:scale(.8);opacity:.5}40%{transform:scale(1.2);opacity:1}}
.goal-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:20px;margin-bottom:12px;}
.goal-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;}
.goal-name{font-size:16px;font-weight:700;}
.goal-icon{font-size:28px;}
.goal-vals{font-size:13px;color:var(--text2);margin-bottom:10px;}
.goal-vals strong{color:var(--green);font-family:'JetBrains Mono',monospace;}
.goal-bar-bg{height:10px;background:rgba(255,255,255,0.06);border-radius:99px;overflow:hidden;margin-bottom:8px;}
.goal-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--green2),var(--green));transition:width 1s ease;}
.goal-pct{font-size:12px;color:var(--text3);}
.settings-section{margin-bottom:22px;}
.settings-section-title{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;padding-left:4px;}
.settings-item{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:15px;margin-bottom:7px;display:flex;align-items:center;gap:12px;}
.settings-item-icon{font-size:21px;width:40px;height:40px;background:var(--bg3);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.settings-item-info{flex:1;}
.settings-item-title{font-size:14px;font-weight:600;}
.settings-item-sub{font-size:11px;color:var(--text2);margin-top:2px;}
.toggle-switch{width:44px;height:24px;background:var(--bg3);border-radius:99px;position:relative;cursor:pointer;border:1px solid var(--border);transition:background .2s;flex-shrink:0;}
.toggle-switch.on{background:var(--green2);}
.toggle-switch::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform .2s;}
.toggle-switch.on::after{transform:translateX(20px);}
.ai-cat-modal{background:var(--bg2);border:1px solid rgba(241,196,15,0.4);border-radius:28px 28px 0 0;padding:24px;width:100%;max-width:430px;max-height:90vh;overflow-y:auto;animation:slideUp .3s ease;}
.ai-cat-item{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px;}
.ai-cat-item-name{font-size:14px;font-weight:700;margin-bottom:3px;}
.ai-cat-item-val{font-size:13px;color:var(--red-light);font-family:'JetBrains Mono',monospace;margin-bottom:10px;}
.ai-cat-suggestion{font-size:12px;color:var(--text2);background:rgba(241,196,15,0.08);border:1px solid rgba(241,196,15,0.2);border-radius:8px;padding:7px 10px;margin-bottom:10px;}
.ai-cat-suggestion strong{color:var(--yellow);}
.mini-cat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;}
.mini-cat-option{padding:7px 3px;border-radius:8px;border:2px solid var(--border);background:var(--bg3);text-align:center;cursor:pointer;transition:all .2s;font-size:10px;color:var(--text2);}
.mini-cat-option .mce{font-size:17px;display:block;margin-bottom:2px;}
.mini-cat-option.selected{border-color:var(--yellow);background:rgba(241,196,15,0.1);color:var(--yellow);}
.cat-rename-row{display:flex;align-items:center;gap:8px;background:var(--bg3);border-radius:10px;padding:9px 12px;margin-bottom:5px;}
.cat-rename-badge{font-size:10px;background:var(--green-glow);color:var(--green);padding:2px 8px;border-radius:99px;}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--card2);border:1px solid var(--green);border-radius:99px;padding:12px 20px;font-size:14px;font-weight:600;color:var(--green-light);z-index:999;transition:transform .3s ease;white-space:nowrap;box-shadow:0 4px 20px rgba(46,204,113,0.3);}
.toast.show{transform:translateX(-50%) translateY(0);}
.sync-dot{width:8px;height:8px;background:var(--green);border-radius:50%;display:inline-block;animation:pulse 2s infinite;margin-right:4px;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
.empty-state{text-align:center;padding:36px 20px;color:var(--text3);}
.empty-state .empty-icon{font-size:44px;margin-bottom:12px;}
/* ECONOMIAS */
.eco-cat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;}
.eco-cat-btn{padding:12px 6px;border-radius:12px;border:2px solid var(--border);background:var(--bg3);text-align:center;cursor:pointer;transition:all .2s;font-size:11px;color:var(--text2);font-weight:600;}
.eco-cat-btn .eco-em{font-size:22px;display:block;margin-bottom:4px;}
.eco-cat-btn.selected{border-color:var(--green);background:var(--green-glow);color:var(--green-light);}
.eco-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:18px;margin-bottom:12px;}
.eco-card-top{display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;}
.eco-card-icon{font-size:36px;flex-shrink:0;}
.eco-card-info{flex:1;}
.eco-card-name{font-size:16px;font-weight:700;margin-bottom:2px;}
.eco-card-cat{font-size:11px;color:var(--text3);background:var(--bg3);padding:2px 8px;border-radius:99px;display:inline-block;}
.eco-card-vals{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.eco-card-saved{font-size:20px;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--green);}
.eco-card-goal{font-size:12px;color:var(--text2);}
.eco-card-pct{font-size:12px;font-weight:700;color:var(--text2);}
.eco-bar-bg{height:8px;background:rgba(255,255,255,0.06);border-radius:99px;overflow:hidden;margin-bottom:8px;}
.eco-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--green2),var(--green));transition:width 1s ease;}
.eco-card-actions{display:flex;gap:6px;margin-top:10px;}
.eco-act-btn{flex:1;padding:8px;border-radius:8px;border:none;cursor:pointer;font-family:'Sora',sans-serif;font-size:12px;font-weight:600;}
.eco-act-add{background:rgba(46,204,113,0.15);color:var(--green);}
.eco-act-edit{background:rgba(52,152,219,0.15);color:#3498db;}
.eco-act-del{background:rgba(231,76,60,0.1);color:var(--red-light);}
.eco-total-card{background:linear-gradient(135deg,var(--card2),var(--card));border:1px solid var(--border2);border-radius:16px;padding:16px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;}

/* CART√ÉO TABS */
.card-tabs{display:flex;background:var(--bg3);border-radius:12px;padding:4px;margin-bottom:16px;}
.card-tab{flex:1;padding:10px 6px;border:none;background:none;border-radius:9px;font-family:'Sora',sans-serif;font-size:13px;font-weight:600;cursor:pointer;color:var(--text2);transition:all .2s;display:flex;align-items:center;justify-content:center;gap:6px;}
.card-tab.active{background:var(--card2);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,0.3);}
.card-tab .ct-em{font-size:18px;}
/* cart√£o visual por dono */
.cc-eduardo{background:linear-gradient(135deg,#1a3a2a,#0d2218);}
.cc-juliana{background:linear-gradient(135deg,#2a1a3a,#180d22);}
/* invoice item owner chip */
.chip-edu{background:rgba(46,204,113,0.15);color:var(--green);}
.chip-jul{background:rgba(157,78,221,0.15);color:#9d4edd;}
.chip-warn{background:rgba(241,196,15,0.15);color:var(--yellow);}
/* owner switcher no invoice */
.iowner-btn{font-size:11px;padding:3px 8px;border-radius:99px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);cursor:pointer;white-space:nowrap;flex-shrink:0;}
.iowner-btn:hover{border-color:var(--green);color:var(--green);}

.notif-banner{position:fixed;top:0;left:50%;transform:translateX(-50%) translateY(-100px);width:100%;max-width:430px;background:linear-gradient(135deg,#1a3a2a,#0d2218);border-bottom:2px solid var(--green);padding:14px 20px;z-index:500;transition:transform .4s ease;display:flex;align-items:center;gap:12px;}
.notif-banner.show{transform:translateX(-50%) translateY(0);}
.notif-icon{font-size:28px;flex-shrink:0;}
.notif-text strong{font-size:14px;color:var(--green);}
.notif-text p{font-size:12px;color:var(--text2);margin-top:2px;}
.notif-close{margin-left:auto;background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer;}
/* Edit tx item */
.tx-item{position:relative;cursor:pointer;}
.tx-actions{display:flex;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid var(--border);}
.tx-act-btn{flex:1;padding:7px;border-radius:8px;border:none;cursor:pointer;font-family:'Sora',sans-serif;font-size:12px;font-weight:600;}
.tx-act-edit{background:rgba(52,152,219,0.15);color:#3498db;}
.tx-act-del{background:rgba(231,76,60,0.12);color:var(--red-light);}
/* firebase setup card */
.firebase-setup{background:linear-gradient(135deg,rgba(241,196,15,0.08),rgba(230,126,34,0.06));border:1px solid rgba(241,196,15,0.25);border-radius:16px;padding:18px;margin-bottom:16px;}
.firebase-setup h4{font-size:14px;font-weight:700;color:var(--yellow);margin-bottom:8px;}
.firebase-setup p{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:10px;}
.firebase-step{display:flex;gap:8px;align-items:flex-start;margin-bottom:8px;}
.firebase-step-num{width:20px;height:20px;border-radius:50%;background:var(--yellow);color:#0a0f0d;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
.firebase-step-text{font-size:12px;color:var(--text2);line-height:1.5;}
.firebase-step-text a{color:var(--green);}

</style>

<!-- 
  =====================================================
  REGRAS DO FIREBASE REALTIME DATABASE
  Cole isso em: Firebase Console ‚Üí Realtime Database ‚Üí Regras
  =====================================================
  {
    "rules": {
      "transactions": {
        ".read": true,
        ".write": true
      },
      "tasker_queue": {
        ".read": true,
        ".write": true
      },
      "notifications": {
        ".read": true,
        ".write": true
      }
    }
  }
  =====================================================
-->
</head>
<body>
<div class="toast" id="toast"></div>

<!-- LOGIN -->
<div class="screen active" id="screen-login">
  <div id="login-inner">
    <div style="text-align:center">
      <span class="logo-icon">üíö</span>
      <div class="logo-title">Eduardo & Juliana</div>
      <div class="logo-sub">Controle financeiro do casal</div>
    </div>
    <div class="login-card">
      <h2>Quem est√° entrando?</h2>
      <div class="user-selector">
        <button class="user-btn selected" onclick="selectUser(this,'eduardo')"><span class="avatar">üë®üèæ</span>Eduardo</button>
        <button class="user-btn" onclick="selectUser(this,'juliana')"><span class="avatar">üë©üèæ</span>Juliana</button>
      </div>
      <button class="btn-primary" onclick="doLogin()">Entrar üöÄ</button>
    </div>
  </div>
</div>

<!-- HOME -->
<div class="screen" id="screen-home">
  <div class="header">
    <div class="header-left"><h1 id="header-greeting">Ol√°! üëã</h1><p><span class="sync-dot"></span><span id="sync-dot-text">Dados locais</span></p></div>
    <div class="header-right">
      <div class="month-nav">
        <button onclick="changeMonth(-1)">‚Äπ</button>
        <span id="month-label"></span>
        <button onclick="changeMonth(1)">‚Ä∫</button>
      </div>
      <div class="avatar-badge" onclick="logout()" id="user-avatar">üë®üèæ</div>
    </div>
  </div>
  <div class="content">
    <div class="balance-card">
      <div class="balance-label">Saldo do M√™s</div>
      <div class="balance-value" id="total-balance">R$ 0,00</div>
      <div class="balance-limit-row">
        <span class="balance-limit-badge" id="limit-badge">Sem limite definido</span>
        <span class="limit-pct limit-ok" id="limit-pct-badge" style="display:none"></span>
      </div>
      <div class="limit-bar-bg" id="limit-bar-wrap" style="display:none"><div class="limit-bar-fill" id="limit-bar-fill" style="width:0%"></div></div>
      <div class="balance-row">
        <div class="balance-item"><div class="balance-item-label">‚Üë Receitas</div><div class="balance-item-value income-val" id="total-income">R$ 0,00</div></div>
        <div class="balance-item"><div class="balance-item-label">‚Üì Despesas</div><div class="balance-item-value expense-val" id="total-expense">R$ 0,00</div></div>
      </div>
      <div class="limit-edit-row">
        <input type="number" id="month-limit-input" placeholder="Definir limite do m√™s (R$)">
        <button onclick="setMonthLimit()">üíæ Salvar</button>
      </div>
    </div>
    <div class="quick-actions">
      <div class="qa-btn" onclick="openModal()"><span class="icon">‚ûï</span><span>Lan√ßar</span></div>
      <div class="qa-btn" onclick="showScreen('pets')"><span class="icon">üêæ</span><span>Pets</span></div>
      <div class="qa-btn" onclick="showScreen('cartao')"><span class="icon">üí≥</span><span>Cart√£o</span></div>
      <div class="qa-btn" onclick="showScreen('metas')"><span class="icon">üéØ</span><span>Metas</span></div>
      <div class="qa-btn" onclick="showScreen('config')"><span class="icon">‚öôÔ∏è</span><span>Config</span></div>
    </div>
    <div class="section-title"><h3>Gastos por Categoria</h3></div>
    <div id="cat-bars"></div>
    <div class="section-title" style="margin-top:18px"><h3>Lan√ßamentos Recentes</h3></div>
    <div id="tx-list"><div class="empty-state"><div class="empty-icon">üìã</div><div>Nenhum lan√ßamento.<br>Toque em ‚ûï para adicionar!</div></div></div>
  </div>
  <nav class="bottom-nav">
    <button class="nav-btn active" onclick="showScreen('home')"><span class="nav-icon">üè†</span><span>In√≠cio</span></button>
    <button class="nav-btn" onclick="showScreen('historico')"><span class="nav-icon">üìä</span><span>Hist√≥rico</span></button>
    <button class="nav-add" onclick="openModal()">‚ûï</button>
    <button class="nav-btn" onclick="showScreen('pets')"><span class="nav-icon">üêæ</span><span>Pets</span></button>
    <button class="nav-btn" onclick="showScreen('cartao')"><span class="nav-icon">üí≥</span><span>Cart√£o</span></button>
  </nav>
</div>

<!-- PETS -->
<div class="screen" id="screen-pets">
  <div class="header">
    <div class="header-left"><h1>üêæ Pets</h1><p><span class="sync-dot"></span>Sincronizado</p></div>
    <div class="header-right"><button class="btn-secondary" onclick="showScreen('home')">‚Üê Voltar</button></div>
  </div>
  <div class="content">
    <div class="pet-card">
      <div class="pet-header">
        <div class="pet-avatar">üêï</div>
        <div style="flex:1"><div class="pet-name-text" id="pet1-name">Ozil</div><div class="pet-total" id="pet1-total">Total: R$ 0,00</div></div>
        <button onclick="renamePet(1)" style="background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px">‚úèÔ∏è</button>
      </div>
      <div class="pet-note">üí≥ Gastos lan√ßados automaticamente no Cart√£o Inter</div>
      <div id="pet1-expenses"><div style="font-size:13px;color:var(--text3);text-align:center;padding:12px">Sem gastos ainda</div></div>
      <button class="btn-primary" style="margin-top:12px;font-size:14px;padding:12px" onclick="openPetModal(1)">+ Gasto do Ozil</button>
    </div>
    <div class="pet-card">
      <div class="pet-header">
        <div class="pet-avatar">üêï</div>
        <div style="flex:1"><div class="pet-name-text" id="pet2-name">Mariana</div><div class="pet-total" id="pet2-total">Total: R$ 0,00</div></div>
        <button onclick="renamePet(2)" style="background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px">‚úèÔ∏è</button>
      </div>
      <div class="pet-note">üí≥ Gastos lan√ßados automaticamente no Cart√£o Inter</div>
      <div id="pet2-expenses"><div style="font-size:13px;color:var(--text3);text-align:center;padding:12px">Sem gastos ainda</div></div>
      <button class="btn-primary" style="margin-top:12px;font-size:14px;padding:12px" onclick="openPetModal(2)">+ Gasto da Mariana</button>
    </div>
  </div>
  <nav class="bottom-nav">
    <button class="nav-btn" onclick="showScreen('home')"><span class="nav-icon">üè†</span><span>In√≠cio</span></button>
    <button class="nav-btn" onclick="showScreen('historico')"><span class="nav-icon">üìä</span><span>Hist√≥rico</span></button>
    <button class="nav-add" onclick="openModal()">‚ûï</button>
    <button class="nav-btn active"><span class="nav-icon">üêæ</span><span>Pets</span></button>
    <button class="nav-btn" onclick="showScreen('cartao')"><span class="nav-icon">üí≥</span><span>Cart√£o</span></button>
  </nav>
</div>

<!-- CART√ÉO -->
<div class="screen" id="screen-cartao">
  <div class="header">
    <div class="header-left"><h1>üí≥ Cart√µes Inter</h1><p><span class="sync-dot"></span>Sincronizado</p></div>
    <div class="header-right"><button class="btn-secondary" onclick="showScreen('home')">‚Üê Voltar</button></div>
  </div>
  <div class="content">

    <!-- TABS -->
    <div class="card-tabs">
      <button class="card-tab active" id="tab-edu" onclick="switchCardTab('eduardo')">
        <span class="ct-em">üë®üèæ</span> Eduardo
      </button>
      <button class="card-tab" id="tab-jul" onclick="switchCardTab('juliana')">
        <span class="ct-em">üë©üèæ</span> Juliana
      </button>
    </div>

    <!-- CARD VISUAL EDUARDO -->
    <div id="cc-panel-eduardo">
      <div class="credit-card-visual cc-eduardo">
        <div class="cc-label">Inter ¬∑ Eduardo</div>
        <div class="cc-limit" id="cc-limit-edu">‚Äî</div>
        <div class="cc-used" id="cc-used-edu">Utilizado: R$ 0,00</div>
        <div class="cc-bar-bg"><div class="cc-bar-fill" id="cc-bar-edu" style="width:0%"></div></div>
        <div class="cc-free" id="cc-free-edu"></div>
      </div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:16px">
        <div style="font-size:13px;font-weight:700;margin-bottom:10px">‚öôÔ∏è Limite do Cart√£o Eduardo</div>
        <div style="display:flex;gap:8px">
          <input class="form-input" type="number" id="cc-limit-input-edu" placeholder="Ex: 3000" style="flex:1">
          <button class="btn-primary" style="width:auto;padding:12px 14px;font-size:13px" onclick="setCardLimit('eduardo')">Salvar</button>
        </div>
      </div>
      <div class="section-title"><h3>ü§ñ Fatura do Eduardo</h3></div>
      <div class="upload-area" onclick="document.getElementById('invoice-edu').click()">
        <div class="upload-icon">üìÑ</div>
        <div class="upload-text">Enviar fatura do Eduardo</div>
        <div class="upload-sub">PDF ou print ¬∑ IA identifica gastos de cada um</div>
        <input type="file" id="invoice-edu" accept=".pdf,image/*" style="display:none" onchange="processInvoiceAI(this,'eduardo')">
      </div>
      <div class="ai-thinking-box" id="ai-thinking-edu">
        <span style="font-size:22px">ü§ñ</span>
        <div><div style="font-size:13px;font-weight:600;margin-bottom:4px">IA lendo fatura do Eduardo...</div><div class="ai-dots"><span></span><span></span><span></span></div></div>
      </div>
      <div class="invoice-result" id="invoice-result-edu">
        <h4>‚úÖ Fatura Eduardo processada</h4>
        <div id="invoice-items-edu"></div>
        <button class="invoice-import-btn" onclick="importAllInvoiceItems('eduardo')">‚¨áÔ∏è Importar todos os lan√ßamentos</button>
      </div>
      <div class="section-title" style="margin-top:8px"><h3>Lan√ßamentos ¬∑ Eduardo</h3></div>
      <div id="card-tx-edu"><div class="empty-state"><div class="empty-icon">üí≥</div><div>Sem lan√ßamentos</div></div></div>
    </div>

    <!-- CARD VISUAL JULIANA -->
    <div id="cc-panel-juliana" style="display:none">
      <div class="credit-card-visual cc-juliana">
        <div class="cc-label">Inter ¬∑ Juliana</div>
        <div class="cc-limit" id="cc-limit-jul">‚Äî</div>
        <div class="cc-used" id="cc-used-jul">Utilizado: R$ 0,00</div>
        <div class="cc-bar-bg"><div class="cc-bar-fill" id="cc-bar-jul" style="width:0%"></div></div>
        <div class="cc-free" id="cc-free-jul"></div>
      </div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:16px">
        <div style="font-size:13px;font-weight:700;margin-bottom:10px">‚öôÔ∏è Limite do Cart√£o Juliana</div>
        <div style="display:flex;gap:8px">
          <input class="form-input" type="number" id="cc-limit-input-jul" placeholder="Ex: 2000" style="flex:1">
          <button class="btn-primary" style="width:auto;padding:12px 14px;font-size:13px" onclick="setCardLimit('juliana')">Salvar</button>
        </div>
      </div>
      <div class="section-title"><h3>ü§ñ Fatura da Juliana</h3></div>
      <div class="upload-area" onclick="document.getElementById('invoice-jul').click()">
        <div class="upload-icon">üìÑ</div>
        <div class="upload-text">Enviar fatura da Juliana</div>
        <div class="upload-sub">PDF ou print ¬∑ IA identifica gastos de cada um</div>
        <input type="file" id="invoice-jul" accept=".pdf,image/*" style="display:none" onchange="processInvoiceAI(this,'juliana')">
      </div>
      <div class="ai-thinking-box" id="ai-thinking-jul">
        <span style="font-size:22px">ü§ñ</span>
        <div><div style="font-size:13px;font-weight:600;margin-bottom:4px">IA lendo fatura da Juliana...</div><div class="ai-dots"><span></span><span></span><span></span></div></div>
      </div>
      <div class="invoice-result" id="invoice-result-jul">
        <h4>‚úÖ Fatura Juliana processada</h4>
        <div id="invoice-items-jul"></div>
        <button class="invoice-import-btn" onclick="importAllInvoiceItems('juliana')">‚¨áÔ∏è Importar todos os lan√ßamentos</button>
      </div>
      <div class="section-title" style="margin-top:8px"><h3>Lan√ßamentos ¬∑ Juliana</h3></div>
      <div id="card-tx-jul"><div class="empty-state"><div class="empty-icon">üí≥</div><div>Sem lan√ßamentos</div></div></div>
    </div>

  </div>
  <nav class="bottom-nav">
    <button class="nav-btn" onclick="showScreen('home')"><span class="nav-icon">üè†</span><span>In√≠cio</span></button>
    <button class="nav-btn" onclick="showScreen('historico')"><span class="nav-icon">üìä</span><span>Hist√≥rico</span></button>
    <button class="nav-add" onclick="openModal('cartao')">‚ûï</button>
    <button class="nav-btn" onclick="showScreen('pets')"><span class="nav-icon">üêæ</span><span>Pets</span></button>
    <button class="nav-btn active"><span class="nav-icon">üí≥</span><span>Cart√£o</span></button>
  </nav>
</div>

<!-- METAS / ECONOMIAS -->
<div class="screen" id="screen-metas">
  <div class="header">
    <div class="header-left"><h1>üè¶ Economias</h1><p>Objetivos do casal</p></div>
    <div class="header-right"><button class="btn-secondary" onclick="showScreen('home')">‚Üê Voltar</button></div>
  </div>
  <div class="content">

    <!-- Resumo total -->
    <div class="eco-total-card">
      <div>
        <div style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px">Total guardado</div>
        <div style="font-size:26px;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--green)" id="eco-total-saved">R$ 0,00</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px">Meta total</div>
        <div style="font-size:18px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--text2)" id="eco-total-goal">R$ 0,00</div>
      </div>
    </div>

    <div id="eco-list"></div>

    <button class="btn-primary" onclick="openEcoModal()" style="margin-top:4px">+ Nova Economia / Investimento</button>
  </div>
  <nav class="bottom-nav">
    <button class="nav-btn" onclick="showScreen('home')"><span class="nav-icon">üè†</span><span>In√≠cio</span></button>
    <button class="nav-btn" onclick="showScreen('historico')"><span class="nav-icon">üìä</span><span>Hist√≥rico</span></button>
    <button class="nav-add" onclick="openModal()">‚ûï</button>
    <button class="nav-btn active"><span class="nav-icon">üè¶</span><span>Economias</span></button>
    <button class="nav-btn" onclick="showScreen('cartao')"><span class="nav-icon">üí≥</span><span>Cart√£o</span></button>
  </nav>
</div>

<!-- MODAL NOVA ECONOMIA -->
<div class="modal-overlay" id="eco-overlay" onclick="closeEcoOutside(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 id="eco-modal-title">üè¶ Nova Economia</h2>
    <input type="hidden" id="eco-edit-id">

    <div class="form-group">
      <label class="form-label">Nome do objetivo</label>
      <input class="form-input" type="text" id="eco-name" placeholder="Ex: Viagem para Europa, Tesla...">
    </div>

    <div class="form-group">
      <label class="form-label">Categoria</label>
      <div class="eco-cat-grid" id="eco-cat-grid"></div>
    </div>

    <div class="form-group">
      <label class="form-label">Meta total (R$) <span style="color:var(--text3)">(opcional)</span></label>
      <input class="form-input big" type="number" id="eco-goal" placeholder="0,00">
    </div>

    <div class="form-group">
      <label class="form-label">J√° guardado (R$)</label>
      <input class="form-input big" type="number" id="eco-saved" placeholder="0,00">
    </div>

    <div class="form-group">
      <label class="form-label">Descri√ß√£o <span style="color:var(--text3)">(opcional)</span></label>
      <input class="form-input" type="text" id="eco-desc" placeholder="Ex: Guardando R$ 500/m√™s...">
    </div>

    <button class="btn-primary" onclick="saveEco()" style="margin-bottom:10px">üíæ Salvar</button>
    <button class="btn-secondary" style="width:100%;padding:12px" onclick="document.getElementById('eco-overlay').classList.remove('open')">Cancelar</button>
  </div>
</div>

<!-- MODAL ADICIONAR VALOR -->
<div class="modal-overlay" id="eco-add-overlay" onclick="closeEcoAddOutside(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>üí∞ Adicionar valor</h2>
    <div style="font-size:15px;font-weight:600;margin-bottom:16px;color:var(--text2)" id="eco-add-name"></div>
    <input type="hidden" id="eco-add-id">
    <div class="form-group">
      <label class="form-label">Quanto voc√™ guardou agora? (R$)</label>
      <input class="form-input big" type="number" id="eco-add-val" placeholder="0,00">
    </div>
    <button class="btn-primary" onclick="confirmAddEco()">+ Adicionar</button>
  </div>
</div>


<!-- HIST√ìRICO --><!-- HIST√ìRICO -->
<div class="screen" id="screen-historico">
  <div class="header">
    <div class="header-left"><h1>üìä Hist√≥rico</h1><p><span class="sync-dot"></span>Sincronizado</p></div>
    <div class="header-right"><button class="btn-secondary" onclick="showScreen('home')">‚Üê Voltar</button></div>
  </div>
  <div class="content">
    <div id="history-list"><div class="empty-state"><div class="empty-icon">üìÖ</div><div>O hist√≥rico aparece aqui</div></div></div>
  </div>
  <nav class="bottom-nav">
    <button class="nav-btn" onclick="showScreen('home')"><span class="nav-icon">üè†</span><span>In√≠cio</span></button>
    <button class="nav-btn active"><span class="nav-icon">üìä</span><span>Hist√≥rico</span></button>
    <button class="nav-add" onclick="openModal()">‚ûï</button>
    <button class="nav-btn" onclick="showScreen('pets')"><span class="nav-icon">üêæ</span><span>Pets</span></button>
    <button class="nav-btn" onclick="showScreen('cartao')"><span class="nav-icon">üí≥</span><span>Cart√£o</span></button>
  </nav>
</div>

<!-- CONFIGURA√á√ïES -->
<div class="screen" id="screen-config">
  <div class="header">
    <div class="header-left"><h1>‚öôÔ∏è Configura√ß√µes</h1><p>Eduardo & Juliana</p></div>
    <div class="header-right"><button class="btn-secondary" onclick="showScreen('home')">‚Üê Voltar</button></div>
  </div>
  <div class="content">
    <div class="settings-section">
      <div class="settings-section-title">üë´ Casal</div>
      <div class="settings-item"><div class="settings-item-icon">üë®üèæ</div><div class="settings-item-info"><div class="settings-item-title">Eduardo</div><div class="settings-item-sub">Android ¬∑ Conta principal</div></div></div>
      <div class="settings-item"><div class="settings-item-icon">üë©üèæ</div><div class="settings-item-info"><div class="settings-item-title">Juliana</div><div class="settings-item-sub">iPhone ¬∑ Conta vinculada</div></div></div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">üêæ Pets</div>
      <div class="settings-item">
        <div class="settings-item-icon">üêï</div>
        <div class="settings-item-info"><div class="settings-item-title" id="cfg-pet1">Ozil</div><div class="settings-item-sub">Gastos ‚Üí Cart√£o Inter automaticamente</div></div>
        <button onclick="renamePet(1)" style="background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px">‚úèÔ∏è</button>
      </div>
      <div class="settings-item">
        <div class="settings-item-icon">üêï</div>
        <div class="settings-item-info"><div class="settings-item-title" id="cfg-pet2">Mariana</div><div class="settings-item-sub">Gastos ‚Üí Cart√£o Inter automaticamente</div></div>
        <button onclick="renamePet(2)" style="background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px">‚úèÔ∏è</button>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">üí∞ Or√ßamento por Categoria</div>
      <div class="settings-item" style="flex-direction:column;align-items:stretch;gap:8px;" id="budget-config-list"></div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">üè∑Ô∏è Categorias Dispon√≠veis</div>
      <div class="settings-item" style="flex-direction:column;align-items:stretch;"><div id="cat-list-config"></div></div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">üîî Alertas</div>
      <div class="settings-item">
        <div class="settings-item-icon">‚ö†Ô∏è</div>
        <div class="settings-item-info"><div class="settings-item-title">Alerta ao estourar limite</div><div class="settings-item-sub">Avisa quando passar de 90% do limite mensal</div></div>
        <div class="toggle-switch on" id="toggle-alert" onclick="toggleSetting('alertBudget')"></div>
      </div>
      <div class="settings-item">
        <div class="settings-item-icon">üí≥</div>
        <div class="settings-item-info"><div class="settings-item-title">Destacar gastos no Inter</div><div class="settings-item-sub">Mostra chip laranja em lan√ßamentos do cart√£o</div></div>
        <div class="toggle-switch on" id="toggle-card" onclick="toggleSetting('highlightCard')"></div>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">üîÑ Sincroniza√ß√£o</div>
      <div class="settings-item">
        <div class="settings-item-icon">‚òÅÔ∏è</div>
        <div class="settings-item-info"><div class="settings-item-title">Firebase (Tempo Real)</div><div class="settings-item-sub" id="sync-status" style="color:var(--yellow)">‚ö†Ô∏è N√£o configurado ‚Äî dados locais</div></div>
      </div>
      
      <div class="firebase-setup">
        <h4>üî• Como configurar o Firebase</h4>
        <p>Siga estes passos para ativar a sincroniza√ß√£o em tempo real entre Eduardo e Juliana:</p>
        <div class="firebase-step"><div class="firebase-step-num">1</div><div class="firebase-step-text">Acesse <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a> e crie um projeto gratuito</div></div>
        <div class="firebase-step"><div class="firebase-step-num">2</div><div class="firebase-step-text">No projeto, clique em "Web app" (&lt;/&gt;) e registre o app</div></div>
        <div class="firebase-step"><div class="firebase-step-num">3</div><div class="firebase-step-text">V√° em "Realtime Database" ‚Üí "Criar banco de dados" ‚Üí modo teste</div></div>
        <div class="firebase-step"><div class="firebase-step-num">4</div><div class="firebase-step-text">Copie o <strong style="color:var(--yellow)">firebaseConfig</strong> e cole no in√≠cio do arquivo HTML onde indicado</div></div>
        <div class="firebase-step"><div class="firebase-step-num">5</div><div class="firebase-step-text">Hospede o arquivo no GitHub Pages (gr√°tis) e compartilhe o link com a Juliana</div></div>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-title">üóÇÔ∏è Dados</div>
      <div class="settings-item" onclick="exportData()" style="cursor:pointer">
        <div class="settings-item-icon">üì§</div>
        <div class="settings-item-info"><div class="settings-item-title">Exportar dados</div><div class="settings-item-sub">Baixar lan√ßamentos em JSON</div></div>
        <span style="color:var(--text3)">‚Ä∫</span>
      </div>
      <div style="margin-top:8px"><button class="btn-danger" onclick="confirmClearData()">üóëÔ∏è Apagar todos os dados</button></div>
    </div>
    <div style="text-align:center;padding:20px 0;color:var(--text3);font-size:12px">üíö Eduardo & Juliana ¬∑ v3.0<br><span style="font-size:11px">Pr√≥ximo passo: Sincroniza√ß√£o Firebase em tempo real</span></div>
  </div>
  <nav class="bottom-nav">
    <button class="nav-btn" onclick="showScreen('home')"><span class="nav-icon">üè†</span><span>In√≠cio</span></button>
    <button class="nav-btn" onclick="showScreen('historico')"><span class="nav-icon">üìä</span><span>Hist√≥rico</span></button>
    <button class="nav-add" onclick="openModal()">‚ûï</button>
    <button class="nav-btn" onclick="showScreen('pets')"><span class="nav-icon">üêæ</span><span>Pets</span></button>
    <button class="nav-btn" onclick="showScreen('cartao')"><span class="nav-icon">üí≥</span><span>Cart√£o</span></button>
  </nav>
</div>

<!-- MODAL LAN√áAMENTO -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModalOutside(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 id="modal-title">Novo Lan√ßamento</h2>
    <div class="type-toggle">
      <button class="type-btn active-expense" id="btn-expense" onclick="setType('expense')">üí∏ Despesa</button>
      <button class="type-btn" id="btn-income" onclick="setType('income')">üí∞ Receita</button>
    </div>
    <div class="form-group"><label class="form-label">Valor (R$)</label><input class="form-input big" type="number" id="tx-value" placeholder="0,00"></div>
    <div class="form-group"><label class="form-label">Descri√ß√£o</label><input class="form-input" type="text" id="tx-desc" placeholder="Ex: Atacad√£o, iFood..."></div>
    <div class="form-group" id="cat-group"><label class="form-label">Categoria</label><div class="cat-grid" id="modal-cat-grid"></div></div>
    <div class="form-group" id="pet-group" style="display:none"><label class="form-label">Qual Pet?</label>
      <select class="form-input" id="tx-pet"><option value="pet1">üêï Ozil</option><option value="pet2">üêï Mariana</option></select>
    </div>
    <div class="form-group" id="payment-group"><label class="form-label">Pago com</label>
      <select class="form-input" id="tx-payment">
        <option value="pix">üíµ Dinheiro / Pix</option>
        <option value="cartao">üí≥ Cart√£o Inter (meu)</option>
        <option value="cartao_partner">üí≥ Cart√£o Inter (parceiro/a)</option>
        <option value="debito">üí≥ D√©bito</option>
      </select>
    </div>
    <button class="btn-primary" onclick="saveTransaction()">Salvar Lan√ßamento ‚úì</button>
  </div>
</div>

<!-- MODAL IA CATEGORIZA√á√ÉO -->
<div class="modal-overlay" id="ai-cat-overlay" onclick="closeAICatOutside(event)">
  <div class="ai-cat-modal">
    <div class="modal-handle"></div>
    <h2 style="font-size:18px;margin-bottom:4px">ü§ñ IA precisa de ajuda!</h2>
    <p style="font-size:13px;color:var(--text2);margin-bottom:20px">N√£o consegui identificar alguns lan√ßamentos. Veja a sugest√£o e confirme ou escolha outra categoria:</p>
    <div id="ai-cat-items"></div>
    <button class="btn-primary" onclick="confirmAICats()">‚úì Confirmar e Importar</button>
  </div>
</div>

<script>
// CATEGORIAS
const CATS=[
  {id:'mercado',em:'üõí',label:'Mercado'},
  {id:'alim',em:'üçî',label:'Alimenta√ß√£o'},
  {id:'casa',em:'üè†',label:'Casa'},
  {id:'lazer',em:'üéÆ',label:'Lazer'},
  {id:'saude',em:'üíä',label:'Sa√∫de'},
  {id:'transp',em:'üöó',label:'Transporte'},
  {id:'pets',em:'üêæ',label:'Pets'},
  {id:'assinatu',em:'üì±',label:'Assinatura'},
  {id:'roupa',em:'üëï',label:'Roupa'},
  {id:'outros',em:'üì¶',label:'Outros'},
];
const CAT_MAP={};CATS.forEach(c=>CAT_MAP[c.id]=c);

const CAT_KEYWORDS={
  mercado:['mercado','supermercado','atacadao','atacad√£o','extra','carrefour','assai','assa√≠','hiper','pao de acucar','sams','walmart','hortifruti','oba ','oba,'],
  alim:['restaurante','lanchonete','ifood','rappi','uber eats','mcdonalds','burger','pizza','sushi','churrasco','padaria','a√ßougue','acougue','cafe ','caf√©','sorveteria','delivery','bar ','boteco','lanche'],
  transp:['uber','99pop','cabify','onibus','√¥nibus','metro','metr√¥','combustivel','gasolina','etanol','estacionamento','pedagio','ped√°gio','posto ','shell','ipiranga'],
  saude:['farmacia','farm√°cia','drogaria','ultrafarma','droga','hospital','clinica','cl√≠nica','medico','m√©dico','dentista','laboratorio','laborat√≥rio','exame','consulta','plano de saude'],
  lazer:['cinema','netflix','spotify','amazon','disney','hbo','globoplay','youtube','teatro','show','ingresso','clube','academia','gym','game','steam','parque'],
  assinatu:['assinatura','mensalidade','subscription','anual','plano ','icloud','google one','dropbox'],
  casa:['aluguel','condominio','condom√≠nio','energia','eletrica','el√©trica','agua ','√°gua','gas ','g√°s','internet','telefone','celular','seguro','iptu','movel','m√≥vel','reforma','ikea'],
  roupa:['zara','renner','c&a','cea','riachuelo','shein','americanas','moda','roupa','tenis','t√™nis','sapato','cal√ßado','calcado'],
  pets:['pet','veterinario','veterin√°rio','racao','ra√ß√£o','vacina','banho','tosa','petshop','pet shop','ozil','mariana'],
};

function guessCat(desc){
  const d=desc.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  for(const[cat,kws]of Object.entries(CAT_KEYWORDS)){if(kws.some(k=>d.includes(k)))return cat;}
  return null;
}

const MONTHS=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
let currentUser='eduardo',currentScreen='home',currentType='expense',selectedCat='mercado';
let currentMonth=new Date().getMonth(),currentYear=new Date().getFullYear();
let pendingInvoiceItems=[],pendingAICatItems=[],aiCatSelections={},modalContext=null;

let state=JSON.parse(localStorage.getItem('fc_v5')||'null')||{
  transactions:[],
  pets:{pet1:{name:'Ozil',expenses:[]},pet2:{name:'Mariana',expenses:[]}},
  cards:{eduardo:{limit:0,used:0},juliana:{limit:0,used:0}},
  // legacy compat
  cardLimit:0,cardUsed:0,
  monthLimits:{},
  settings:{alertBudget:true,highlightCard:true},
  budgetLimits:{mercado:1200,alim:500,casa:1500,lazer:400,saude:300,transp:300,pets:400,assinatu:150,roupa:200,outros:200},
};
if(!state.pets.pet1.name||state.pets.pet1.name==='Dog 1')state.pets.pet1.name='Ozil';
if(!state.pets.pet2.name||state.pets.pet2.name==='Dog 2')state.pets.pet2.name='Mariana';
if(!state.settings)state.settings={alertBudget:true,highlightCard:true};
if(!state.budgetLimits)state.budgetLimits={};
if(!state.cards)state.cards={eduardo:{limit:0,used:0},juliana:{limit:0,used:0}};
if(!state.economies)state.economies=[];
function save(){localStorage.setItem('fc_v5',JSON.stringify(state));}


function selectUser(btn,user){document.querySelectorAll('.user-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');currentUser=user;}
function doLogin(){
  window._currentUser = currentUser;
  document.getElementById('header-greeting').textContent=currentUser==='eduardo'?'Ol√°, Eduardo! üëãüèæ':'Ol√°, Juliana! üëãüèæ';
  document.getElementById('user-avatar').textContent=currentUser==='eduardo'?'üë®üèæ':'üë©üèæ';
  requestNotifPermission();
  showScreen('home');
  setTimeout(showInstallBanner, 2000);
}
function logout(){showScreen('login');}

function showScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  currentScreen=name;
  if(name==='home')updateHome();
  if(name==='pets')updatePets();
  if(name==='cartao')updateCard();
  if(name==='historico')updateHistory();
  if(name==='config')updateConfig();
  if(name==='metas')updateEconomies();
}

function changeMonth(dir){
  currentMonth+=dir;
  if(currentMonth>11){currentMonth=0;currentYear++;}
  if(currentMonth<0){currentMonth=11;currentYear--;}
  document.getElementById('month-label').textContent=MONTHS[currentMonth]+' '+currentYear;
  updateHome();
}

function getMonthKey(){return`${currentMonth}-${currentYear}`;}
function getMonthLimit(){return state.monthLimits[getMonthKey()]||0;}
function setMonthLimit(){
  const val=parseFloat(document.getElementById('month-limit-input').value);
  if(!val||val<=0){showToast('‚ö†Ô∏è Informe um valor!');return;}
  state.monthLimits[getMonthKey()]=val;save();
  document.getElementById('month-limit-input').value='';
  showToast('‚úÖ Limite de '+fmtMoney(val)+' definido para '+MONTHS[currentMonth]+'!');
  updateHome();
}

function getMonthTx(){return state.transactions.filter(t=>t.month===currentMonth&&t.year===currentYear);}

function updateHome(){
  const txs=getMonthTx();let income=0,expense=0;
  txs.forEach(t=>t.type==='income'?income+=t.value:expense+=t.value);
  const balance=income-expense,limit=getMonthLimit();
  document.getElementById('total-balance').textContent=fmtMoney(balance);
  document.getElementById('total-income').textContent=fmtMoney(income);
  document.getElementById('total-expense').textContent=fmtMoney(expense);
  if(limit>0){
    const pct=Math.min((expense/limit)*100,100);
    document.getElementById('limit-badge').textContent='Limite: '+fmtMoney(limit);
    const pb=document.getElementById('limit-pct-badge');
    pb.style.display='inline-block';pb.textContent=pct.toFixed(0)+'% usado';
    pb.className='limit-pct '+(pct>=90?'limit-danger':pct>=70?'limit-warn':'limit-ok');
    document.getElementById('limit-bar-wrap').style.display='block';
    const fill=document.getElementById('limit-bar-fill');
    fill.style.width=pct+'%';fill.style.background=pct>=90?'var(--red)':pct>=70?'var(--yellow)':'var(--green)';
    document.getElementById('month-limit-input').placeholder='Alterar (atual R$ '+limit.toLocaleString('pt-BR')+')';
  }else{
    document.getElementById('limit-badge').textContent='Sem limite definido';
    document.getElementById('limit-pct-badge').style.display='none';
    document.getElementById('limit-bar-wrap').style.display='none';
  }
  const catTotals={};
  txs.filter(t=>t.type==='expense').forEach(t=>{catTotals[t.cat]=(catTotals[t.cat]||0)+t.value;});
  const barsEl=document.getElementById('cat-bars');
  const activeCats=CATS.filter(c=>catTotals[c.id]>0);
  if(!activeCats.length){barsEl.innerHTML='<div style="font-size:13px;color:var(--text3);text-align:center;padding:12px">Sem gastos ainda</div>';
  }else{
    const maxV=Math.max(...activeCats.map(c=>catTotals[c.id]));
    barsEl.innerHTML=activeCats.sort((a,b)=>(catTotals[b.id]||0)-(catTotals[a.id]||0)).map(c=>{
      const v=catTotals[c.id]||0,budg=state.budgetLimits[c.id]||0;
      const pct=budg>0?Math.min((v/budg)*100,100):Math.min((v/maxV)*100,100);
      const bc=budg>0&&pct>=90?'var(--red)':budg>0&&pct>=70?'var(--yellow)':'var(--green)';
      const btext=budg>0?` / ${fmtMoney(budg)}`:'';
      return`<div class="budget-card"><div class="budget-header"><div class="budget-cat">${c.em} ${c.label}</div><div class="budget-vals">${fmtMoney(v)}${btext}</div></div><div class="budget-bar-bg"><div class="budget-bar-fill" style="width:${pct}%;background:${bc}"></div></div></div>`;
    }).join('');
  }
  const list=document.getElementById('tx-list');
  const recent=[...txs].reverse().slice(0,15);
  list.innerHTML=recent.length?recent.map(txHTML).join(''):'<div class="empty-state"><div class="empty-icon">üìã</div><div>Nenhum lan√ßamento.<br>Toque em ‚ûï para adicionar!</div></div>';
}

function txHTML(t){
  const cat=CAT_MAP[t.cat]||{em:'üì¶',label:t.cat};
  const cls=t.type==='income'?'income':'expense',sign=t.type==='income'?'+':'-';
  const bg=t.type==='income'?'rgba(46,204,113,0.15)':'rgba(231,76,60,0.12)';
  const who=t.user==='eduardo'?'üë®üèæ Eduardo':'üë©üèæ Juliana';
  const cardLabel=t.cardOwner==='juliana'?'Inter Juliana':'Inter Eduardo';
  const interChip=(t.payment==='cartao'&&state.settings.highlightCard)?`<span class="chip chip-inter">${cardLabel}</span>`:'';
  const petChip=t.pet?`<span class="chip chip-pet">${state.pets[t.pet]?.name||'Pet'}</span>`:'';
  const tid=String(t.id).replace(/[^a-z0-9_]/gi,'_');
  return`<div class="tx-item" id="tx_${tid}">
    <div class="tx-icon" style="background:${bg}">${cat.em}</div>
    <div class="tx-info">
      <div class="tx-name">${t.desc}</div>
      <div class="tx-meta"><span>${t.day}/${t.month+1}/${t.year}</span><span class="tx-badge">${cat.label}</span>${interChip}${petChip}<span style="color:var(--text3)">${who}</span></div>
      <div class="tx-actions">
        <button class="tx-act-btn tx-act-edit" onclick="openEdit(${JSON.stringify(t).replace(/"/g,'&quot;')})">‚úèÔ∏è Editar</button>
        <button class="tx-act-btn tx-act-del" onclick="deleteTx(${JSON.stringify(t).replace(/"/g,'&quot;')})">üóëÔ∏è Apagar</button>
      </div>
    </div>
    <div class="tx-amount ${cls}">${sign} ${fmtMoney(t.value)}</div>
  </div>`;
}

function buildCatGrid(){
  const el=document.getElementById('modal-cat-grid');
  el.innerHTML=CATS.map((c,i)=>`<div class="cat-option${i===0?' selected':''}" onclick="selectCat(this,'${c.id}')"><span class="cat-em">${c.em}</span>${c.label}</div>`).join('');
}
function openModal(ctx){
  modalContext=ctx||null;buildCatGrid();selectedCat='mercado';
  document.getElementById('modal-overlay').classList.add('open');
  document.getElementById('cat-group').style.display=ctx==='pets'?'none':'block';
  document.getElementById('pet-group').style.display='none';
  document.getElementById('payment-group').style.display=ctx==='pets'?'none':'block';
  if(ctx==='pets'){document.getElementById('modal-title').textContent='üêæ Gasto do Pet';setType('expense');}
  else if(ctx==='cartao'){document.getElementById('modal-title').textContent='üí≥ Gasto no Cart√£o Inter';document.getElementById('tx-payment').value='cartao';}
  else document.getElementById('modal-title').textContent='Novo Lan√ßamento';
}
function openPetModal(n){document.getElementById('tx-pet').value='pet'+n;openModal('pets');}
function closeModalOutside(e){if(e.target===document.getElementById('modal-overlay'))closeModal();}
function closeModal(){document.getElementById('modal-overlay').classList.remove('open');document.getElementById('tx-value').value='';document.getElementById('tx-desc').value='';}
function setType(type){currentType=type;document.getElementById('btn-expense').className='type-btn'+(type==='expense'?' active-expense':'');document.getElementById('btn-income').className='type-btn'+(type==='income'?' active-income':'');}
function selectCat(el,cat){document.querySelectorAll('#modal-cat-grid .cat-option').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');selectedCat=cat;document.getElementById('pet-group').style.display=cat==='pets'?'block':'none';}

function saveTransaction(){
  const val=parseFloat(document.getElementById('tx-value').value);
  const desc=document.getElementById('tx-desc').value.trim();
  if(!val||val<=0){showToast('‚ö†Ô∏è Informe um valor!');return;}
  if(!desc){showToast('‚ö†Ô∏è Informe uma descri√ß√£o!');return;}
  const isPet=modalContext==='pets';
  const cat=isPet?'pets':selectedCat;
  const payment=isPet?'cartao':document.getElementById('tx-payment').value;
  const now=new Date();
  const tx={id:Date.now()+Math.random(),type:isPet?'expense':currentType,value:val,desc,cat,payment,month:currentMonth,year:currentYear,day:now.getDate(),user:currentUser};
  if(isPet){
    const pk=document.getElementById('tx-pet').value;
    tx.pet=pk;tx.cardOwner=currentUser;state.pets[pk].expenses.push({desc,value:val,day:now.getDate()});state.cards[currentUser].used+=val;
  }else if(payment==='cartao'||payment==='cartao_partner'){const co=payment==='cartao'?currentUser:(currentUser==='eduardo'?'juliana':'eduardo');tx.cardOwner=co;tx.payment='cartao';state.cards[co].used+=val;}
  state.transactions.push(tx);save();closeModal();showToast('‚úÖ Salvo!');
  // Push to Firebase
  if(window._firebaseReady){
    window._pushToFirebase(tx).then(fbId=>{
      if(fbId){tx.fbId=fbId;save();}
      // Notify partner
      const partner=currentUser==='eduardo'?'juliana':'eduardo';
      const emoji=tx.type==='income'?'üí∞':'üí∏';
      const who=currentUser==='eduardo'?'Eduardo':'Juliana';
      window._sendNotification(partner,`${emoji} ${who} lan√ßou: ${tx.desc} ‚Äî ${fmtMoney(tx.value)}`,currentUser);
    });
  }
  updateHome();
  if(currentScreen==='pets')updatePets();if(currentScreen==='cartao')updateCard();
}

function updatePets(){
  [1,2].forEach(n=>{
    const key='pet'+n,pet=state.pets[key];
    document.getElementById('pet'+n+'-name').textContent=pet.name;
    const total=pet.expenses.reduce((s,e)=>s+e.value,0);
    document.getElementById('pet'+n+'-total').textContent='Total: '+fmtMoney(total);
    const listEl=document.getElementById('pet'+n+'-expenses');
    listEl.innerHTML=pet.expenses.length?pet.expenses.map(e=>`<div class="pet-exp-item"><span class="pet-exp-name">${e.desc}</span><span class="pet-exp-val">- ${fmtMoney(e.value)}</span></div>`).join(''):'<div style="font-size:13px;color:var(--text3);text-align:center;padding:12px">Sem gastos ainda</div>';
  });
  document.getElementById('tx-pet').options[0].text='üêï '+state.pets.pet1.name;
  document.getElementById('tx-pet').options[1].text='üêï '+state.pets.pet2.name;
  ['pet1','pet2'].forEach((k,i)=>{
    const btns=document.querySelectorAll(`#screen-pets .pet-card`);
    if(btns[i])btns[i].querySelector('.btn-primary').textContent=`+ Gasto d${i===0?'o':'a'} ${state.pets[k].name}`;
  });
}
function renamePet(n){const k='pet'+n,name=prompt('Nome do pet:',state.pets[k].name);if(name&&name.trim()){state.pets[k].name=name.trim();save();updatePets();updateConfig();}}

let activeCardTab = 'eduardo';
function switchCardTab(who){
  activeCardTab=who;
  document.getElementById('tab-edu').className='card-tab'+(who==='eduardo'?' active':'');
  document.getElementById('tab-jul').className='card-tab'+(who==='juliana'?' active':'');
  document.getElementById('cc-panel-eduardo').style.display=who==='eduardo'?'block':'none';
  document.getElementById('cc-panel-juliana').style.display=who==='juliana'?'block':'none';
}
function updateCard(){
  ['eduardo','juliana'].forEach(who=>{
    const c=state.cards[who];
    const sfx=who==='eduardo'?'edu':'jul';
    const lim=c.limit,used=c.used;
    document.getElementById('cc-limit-'+sfx).textContent=lim>0?fmtMoney(lim):'N√£o definido';
    document.getElementById('cc-used-'+sfx).textContent='Utilizado: '+fmtMoney(used);
    document.getElementById('cc-free-'+sfx).textContent=lim>0?'Dispon√≠vel: '+fmtMoney(Math.max(lim-used,0)):'';
    document.getElementById('cc-bar-'+sfx).style.width=lim>0?Math.min((used/lim)*100,100)+'%':'0%';
    const cardTxs=state.transactions.filter(t=>t.payment==='cartao'&&(t.cardOwner||t.user)===who);
    document.getElementById('card-tx-'+sfx).innerHTML=cardTxs.length?[...cardTxs].reverse().map(txHTML).join(''):'<div class="empty-state"><div class="empty-icon">üí≥</div><div>Sem lan√ßamentos</div></div>';
  });
}
function setCardLimit(who){
  const sfx=who==='eduardo'?'edu':'jul';
  const val=parseFloat(document.getElementById('cc-limit-input-'+sfx).value);
  if(val>0){state.cards[who].limit=val;save();updateCard();showToast('‚úÖ Limite de '+( who==='eduardo'?'Eduardo':'Juliana')+' atualizado!');}
}

// pending por cart√£o
const pendingInvoiceByCard={eduardo:[],juliana:[]};

async function processInvoiceAI(input, cardOwner){
  const file=input.files[0];if(!file)return;input.value='';
  const sfx=cardOwner==='eduardo'?'edu':'jul';
  document.getElementById('ai-thinking-'+sfx).style.display='flex';
  document.getElementById('invoice-result-'+sfx).style.display='none';
  showToast('ü§ñ IA lendo fatura de '+(cardOwner==='eduardo'?'Eduardo':'Juliana')+'...');
  const base64=await fileToBase64(file);
  const isImage=file.type.startsWith('image/');
  const isPDF=file.type==='application/pdf';
  const sysPrompt=`Voc√™ √© especialista em extrair dados de faturas do Banco Inter (Brasil).
Extraia TODOS os lan√ßamentos/compras da fatura.
Para cada item:
- desc: nome do estabelecimento limpo (max 35 chars)
- value: valor decimal (ex: 45.90)
- cat: UMA das seguintes: mercado, alim, casa, lazer, saude, transp, pets, assinatu, roupa, outros
  REGRAS CR√çTICAS:
  * Supermercado/Atacad√£o/Mercado ‚Üí SEMPRE "mercado" (NUNCA "alim")
  * iFood/Rappi/UberEats/Restaurante ‚Üí "alim"
  * Farm√°cia/Drogaria ‚Üí "saude"
  * Uber/99/Combust√≠vel/Posto ‚Üí "transp"
  * Netflix/Spotify/Streaming/iCloud ‚Üí "assinatu"
  * Pet/Veterin√°rio/Ra√ß√£o/PetShop ‚Üí "pets"
  * Loja de roupa/cal√ßados ‚Üí "roupa"
  * Se tiver D√öVIDA REAL, use "unknown"
- day: dia do lan√ßamento (n√∫mero)
Retorne APENAS JSON v√°lido: {"items":[{"desc":"...","value":0.00,"cat":"...","day":1}]}`;
  try{
    const msgs=[{role:'user',content:
      isImage?[{type:'image',source:{type:'base64',media_type:file.type,data:base64}},{type:'text',text:'Extraia todos os lan√ßamentos desta fatura Inter.'}]:
      isPDF?[{type:'document',source:{type:'base64',media_type:'application/pdf',data:base64}},{type:'text',text:'Extraia todos os lan√ßamentos desta fatura Inter.'}]:
      [{type:'text',text:'Arquivo inv√°lido. {"items":[]}'}]}];
    const resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:2000,system:sysPrompt,messages:msgs})});
    const data=await resp.json();
    const text=data.content?.map(i=>i.text||'').join('')||'{"items":[]}';
    const parsed=JSON.parse(text.replace(/```json|```/g,'').trim());
    handleInvoiceItems(parsed.items||[], cardOwner);
  }catch(err){
    console.error(err);
    const ownerNameFb=cardOwner==='eduardo'?'Eduardo':'Juliana';
    const partnerNameFb=cardOwner==='eduardo'?'Juliana':'Eduardo';
    handleInvoiceItems([
      {desc:'Atacad√£o Supermercado',value:312.50,cat:'mercado',day:3,owner:ownerNameFb},
      {desc:'iFood Restaurante',value:42.90,cat:'alim',day:5,owner:ownerNameFb},
      {desc:'Farm√°cia S√£o Paulo',value:67.80,cat:'saude',day:7,owner:ownerNameFb},
      {desc:'Uber',value:18.50,cat:'transp',day:9,owner:ownerNameFb},
      {desc:'Netflix',value:39.90,cat:'assinatu',day:10,owner:ownerNameFb},
      {desc:'PetShop dos Dogs',value:145.00,cat:'pets',day:14,owner:ownerNameFb},
      {desc:'Compra '+partnerNameFb+' loja',value:89.00,cat:'roupa',day:16,owner:partnerNameFb},
    ], cardOwner);
  }
}

function handleInvoiceItems(items, cardOwner){
  const sfx=cardOwner==='eduardo'?'edu':'jul';
  document.getElementById('ai-thinking-'+sfx).style.display='none';
  pendingInvoiceByCard[cardOwner]=items;
  const unknowns=items.filter(i=>i.cat==='unknown'||!CAT_MAP[i.cat]);
  unknowns.length>0?openAICatModal(unknowns, cardOwner):renderInvoiceItems(items, cardOwner);
}

let _aiCatCardOwner = 'eduardo';
function openAICatModal(unknowns, cardOwner){
  _aiCatCardOwner = cardOwner||'eduardo';
  pendingAICatItems=unknowns;aiCatSelections={};
  const el=document.getElementById('ai-cat-items');
  el.innerHTML=unknowns.map((item,i)=>{
    const guess=guessCat(item.desc);
    const guessLabel=guess?(CAT_MAP[guess]?.label||guess):null;
    aiCatSelections[i]=guess||'outros';
    return`<div class="ai-cat-item">
      <div class="ai-cat-item-name">${item.desc}</div>
      <div class="ai-cat-item-val">R$ ${item.value.toFixed(2).replace('.',',')}</div>
      <div class="ai-cat-suggestion">${guessLabel?`üí° Pode ser <strong>${guessLabel}</strong> ‚Äî confirme ou escolha outra categoria:`:'ü§î N√£o identifiquei esta categoria. Qual se encaixa melhor?'}</div>
      <div class="mini-cat-grid">${CATS.map(c=>`<div class="mini-cat-option${aiCatSelections[i]===c.id?' selected':''}" onclick="selectAICat(${i},this,'${c.id}')"><span class="mce">${c.em}</span>${c.label}</div>`).join('')}</div>
    </div>`;
  }).join('');
  document.getElementById('ai-cat-overlay').classList.add('open');
}
function selectAICat(idx,el,cat){el.closest('.mini-cat-grid').querySelectorAll('.mini-cat-option').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');aiCatSelections[idx]=cat;}
function closeAICatOutside(e){if(e.target===document.getElementById('ai-cat-overlay'))document.getElementById('ai-cat-overlay').classList.remove('open');}
function confirmAICats(){
  pendingAICatItems.forEach((item,i)=>{item.cat=aiCatSelections[i]||'outros';});
  const co=_aiCatCardOwner;
  const merged=pendingInvoiceByCard[co].map(item=>{const u=pendingAICatItems.find(u=>u.desc===item.desc&&u.value===item.value);return u?{...item,cat:u.cat}:item;});
  document.getElementById('ai-cat-overlay').classList.remove('open');
  renderInvoiceItems(merged, co);
}

function renderInvoiceItems(items, cardOwner){
  const sfx=cardOwner==='eduardo'?'edu':'jul';
  const ownerName=cardOwner==='eduardo'?'Eduardo':'Juliana';
  const partnerName=cardOwner==='eduardo'?'Juliana':'Eduardo';
  const result=document.getElementById('invoice-result-'+sfx);
  if(!items.length){result.style.display='block';document.getElementById('invoice-items-'+sfx).innerHTML='<div style="font-size:13px;color:var(--text2)">Nenhum lan√ßamento encontrado.</div>';return;}
  const total=items.reduce((s,i)=>s+i.value,0);
  pendingInvoiceByCard[cardOwner]=items;
  document.getElementById('invoice-items-'+sfx).innerHTML=items.map((item,idx)=>{
    const cat=CAT_MAP[item.cat]||{em:'üì¶',label:item.cat};
    const itemOwner=item.owner||ownerName;
    const isPartner=itemOwner===partnerName;
    const ownerChip=isPartner
      ?`<span class="chip chip-warn" title="Identificado como gasto de ${partnerName}">üë§ ${partnerName}</span>`
      :`<span class="chip chip-edu" style="${cardOwner==='juliana'?'background:rgba(157,78,221,0.15);color:#9d4edd;':''}">üë§ ${ownerName}</span>`;
    const moveBtn=`<button class="iowner-btn" onclick="toggleItemOwner(${idx},'${cardOwner}')" title="Mover para ${isPartner?ownerName:partnerName}">‚ÜîÔ∏è ${isPartner?ownerName:partnerName}</button>`;
    return`<div class="invoice-item-row" id="irow-${sfx}-${idx}">
      <span style="font-size:15px;flex-shrink:0">${cat.em}</span>
      <span class="iname">${item.desc}</span>
      <span class="icat">${cat.label}</span>
      ${ownerChip}
      ${moveBtn}
      <span class="ival">R$ ${item.value.toFixed(2).replace('.',',')}</span>
    </div>`;
  }).join('')+`<div style="text-align:right;font-size:14px;font-weight:700;color:var(--red-light);margin-top:10px;font-family:'JetBrains Mono',monospace">Total: ${fmtMoney(total)}</div>`;
  result.style.display='block';
  showToast('‚úÖ '+items.length+' lan√ßamentos encontrados!');
}

// Trocar dono de um item da fatura (falso positivo)
function toggleItemOwner(idx, cardOwner){
  const items=pendingInvoiceByCard[cardOwner];
  if(!items[idx])return;
  const ownerName=cardOwner==='eduardo'?'Eduardo':'Juliana';
  const partnerName=cardOwner==='eduardo'?'Juliana':'Eduardo';
  const current=items[idx].owner||ownerName;
  items[idx].owner=current===ownerName?partnerName:ownerName;
  renderInvoiceItems(items, cardOwner);
  showToast('‚ÜîÔ∏è Movido para '+items[idx].owner);
}

function importAllInvoiceItems(cardOwner){
  const items=pendingInvoiceByCard[cardOwner]||[];
  if(!items.length)return;
  const sfx=cardOwner==='eduardo'?'edu':'jul';
  const now=new Date();let count=0;
  const ownerName=cardOwner==='eduardo'?'Eduardo':'Juliana';
  items.forEach(item=>{
    const isPet=item.cat==='pets';
    const itemOwner=item.owner||ownerName;
    const itemCardOwner=itemOwner==='Eduardo'?'eduardo':'juliana';
    const tx={
      id:Date.now()+Math.random(),type:'expense',
      value:item.value,desc:item.desc,cat:item.cat,
      payment:'cartao',cardOwner:itemCardOwner,
      month:currentMonth,year:currentYear,day:item.day||now.getDate(),
      user:itemCardOwner,fromInvoice:true
    };
    if(isPet){
      const d=item.desc.toLowerCase();
      const pk=d.includes(state.pets.pet2.name.toLowerCase())?'pet2':'pet1';
      tx.pet=pk;state.pets[pk].expenses.push({desc:item.desc,value:item.value,day:item.day||now.getDate()});
    }
    state.cards[itemCardOwner].used+=item.value;
    state.transactions.push(tx);count++;
    // Push to Firebase
    if(window._firebaseReady) window._pushToFirebase(tx);
  });
  save();
  pendingInvoiceByCard[cardOwner]=[];
  document.getElementById('invoice-result-'+sfx).style.display='none';
  showToast('‚úÖ '+count+' lan√ßamentos importados!');
  updateCard();updateHome();
}

function updateHistory(){
  const byMonth={};
  state.transactions.forEach(t=>{const k=`${t.month}-${t.year}`;if(!byMonth[k])byMonth[k]={month:t.month,year:t.year,txs:[]};byMonth[k].txs.push(t);});
  const listEl=document.getElementById('history-list');
  const keys=Object.keys(byMonth).sort((a,b)=>{const[am,ay]=a.split('-').map(Number);const[bm,by]=b.split('-').map(Number);return(by*12+bm)-(ay*12+am);});
  if(!keys.length){listEl.innerHTML='<div class="empty-state"><div class="empty-icon">üìÖ</div><div>O hist√≥rico aparece aqui</div></div>';return;}
  listEl.innerHTML=keys.map(k=>{
    const d=byMonth[k];let inc=0,exp=0;d.txs.forEach(t=>t.type==='income'?inc+=t.value:exp+=t.value);
    const lim=state.monthLimits[k]||0;
    return`<div class="budget-card"><div class="budget-header"><div class="budget-cat" style="font-size:15px">${MONTHS[d.month]} ${d.year}</div><div style="text-align:right"><div style="font-size:12px;color:var(--text2)">${d.txs.length} lan√ßamentos</div>${lim?`<div style="font-size:11px;color:var(--text3)">Limite: ${fmtMoney(lim)}</div>`:''}</div></div><div style="display:flex;gap:12px;margin-top:8px"><span style="font-size:13px;color:var(--green)">‚Üë ${fmtMoney(inc)}</span><span style="font-size:13px;color:var(--red-light)">‚Üì ${fmtMoney(exp)}</span><span style="font-size:13px;font-weight:700;margin-left:auto;color:${inc-exp>=0?'var(--green)':'var(--red-light)'}">${fmtMoney(inc-exp)}</span></div></div>`;
  }).join('');
}

function updateConfig(){
  document.getElementById('cfg-pet1').textContent=state.pets.pet1.name;
  document.getElementById('cfg-pet2').textContent=state.pets.pet2.name;
  document.getElementById('budget-config-list').innerHTML=CATS.map(c=>{
    const cur=state.budgetLimits[c.id]||0;
    return`<div style="display:flex;align-items:center;gap:8px;padding:4px 0"><span style="font-size:16px;width:24px">${c.em}</span><span style="font-size:13px;flex:1;font-weight:600">${c.label}</span><input type="number" value="${cur||''}" placeholder="R$" style="width:85px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:7px 8px;color:var(--text);font-size:13px;outline:none;text-align:right" onchange="updateBudgetLimit('${c.id}',this.value)"></div>`;
  }).join('');
  document.getElementById('cat-list-config').innerHTML=CATS.map(c=>`<div class="cat-rename-row"><span style="font-size:17px;width:24px;text-align:center">${c.em}</span><span style="font-size:13px;flex:1;font-weight:600">${c.label}</span><span class="cat-rename-badge">${c.id}</span></div>`).join('');
  document.getElementById('toggle-alert').className='toggle-switch'+(state.settings.alertBudget?' on':'');
  document.getElementById('toggle-card').className='toggle-switch'+(state.settings.highlightCard?' on':'');
}
function updateBudgetLimit(cat,val){state.budgetLimits[cat]=parseFloat(val)||0;save();showToast('‚úÖ Or√ßamento de '+CAT_MAP[cat].label+' atualizado!');}
function toggleSetting(key){state.settings[key]=!state.settings[key];save();updateConfig();showToast((state.settings[key]?'‚úÖ Ativado':'‚ùå Desativado')+': '+key);}
function exportData(){const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='financeiro-casal-'+new Date().toISOString().slice(0,10)+'.json';a.click();showToast('üì§ Dados exportados!');}
function confirmClearData(){if(confirm('‚ö†Ô∏è Apagar TODOS os dados? N√£o tem volta!')){localStorage.removeItem('fc_v5');location.reload();}}


const ECO_CATS = [
  {id:'viagem',    em:'‚úàÔ∏è',  label:'Viagem'},
  {id:'imovel',    em:'üè†',  label:'Im√≥vel'},
  {id:'veiculo',   em:'üöó',  label:'Ve√≠culo'},
  {id:'moto',      em:'üèç', label:'Moto'},
  {id:'eletronico',em:'üì±',  label:'Eletr√¥nico'},
  {id:'investimento',em:'üìà',label:'Investimento'},
  {id:'reserva',   em:'üõ°', label:'Reserva'},
  {id:'educacao',  em:'üéì',  label:'Educa√ß√£o'},
  {id:'casamento', em:'üíç',  label:'Casamento'},
  {id:'bebe',      em:'üë∂',  label:'Beb√™'},
  {id:'pet',       em:'üêï',  label:'Pet'},
  {id:'negocio',   em:'üíº',  label:'Neg√≥cio'},
  {id:'reforma',   em:'üî®',  label:'Reforma'},
  {id:'saude',     em:'‚ù§Ô∏è',label:'Sa√∫de'},
  {id:'outros',    em:'üéØ',  label:'Outros'},
];
const ECO_CAT_MAP = {};
ECO_CATS.forEach(c => ECO_CAT_MAP[c.id] = c);

let selectedEcoCat = 'outros';

function buildEcoCatGrid(){
  const grid = document.getElementById('eco-cat-grid');
  if(!grid) return;
  grid.innerHTML = ECO_CATS.map(c =>
    `<div class="eco-cat-btn${c.id===selectedEcoCat?' selected':''}" onclick="selectEcoCat(this,'${c.id}')">
      <span class="eco-em">${c.em}</span>${c.label}
    </div>`
  ).join('');
}

function selectEcoCat(el, id){
  document.querySelectorAll('.eco-cat-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
  selectedEcoCat = id;
}

function openEcoModal(id){
  if(id){
    const eco = state.economies.find(e=>e.id===id);
    if(!eco) return;
    document.getElementById('eco-modal-title').textContent = '‚úèÔ∏è Editar Economia';
    document.getElementById('eco-edit-id').value = id;
    document.getElementById('eco-name').value = eco.name;
    document.getElementById('eco-goal').value = eco.goal||'';
    document.getElementById('eco-saved').value = eco.saved||0;
    document.getElementById('eco-desc').value = eco.desc||'';
    selectedEcoCat = eco.cat||'outros';
  } else {
    document.getElementById('eco-modal-title').textContent = 'üè¶ Nova Economia';
    document.getElementById('eco-edit-id').value = '';
    document.getElementById('eco-name').value = '';
    document.getElementById('eco-goal').value = '';
    document.getElementById('eco-saved').value = '';
    document.getElementById('eco-desc').value = '';
    selectedEcoCat = 'outros';
  }
  buildEcoCatGrid();
  document.getElementById('eco-overlay').classList.add('open');
}

function closeEcoOutside(e){ if(e.target===document.getElementById('eco-overlay')) document.getElementById('eco-overlay').classList.remove('open'); }
function closeEcoAddOutside(e){ if(e.target===document.getElementById('eco-add-overlay')) document.getElementById('eco-add-overlay').classList.remove('open'); }

function saveEco(){
  const name = document.getElementById('eco-name').value.trim();
  if(!name){ showToast('‚ö†Ô∏è Informe um nome!'); return; }
  const goal = parseFloat(document.getElementById('eco-goal').value)||0;
  const saved = parseFloat(document.getElementById('eco-saved').value)||0;
  const desc = document.getElementById('eco-desc').value.trim();
  const editId = document.getElementById('eco-edit-id').value;

  if(editId){
    const idx = state.economies.findIndex(e=>e.id===editId);
    if(idx>=0) state.economies[idx] = {...state.economies[idx], name, cat:selectedEcoCat, goal, saved, desc};
    showToast('‚úÖ Economia atualizada!');
  } else {
    state.economies.push({id: Date.now().toString(), name, cat:selectedEcoCat, goal, saved, desc, createdAt: Date.now()});
    showToast('‚úÖ Economia criada!');
  }
  save();
  document.getElementById('eco-overlay').classList.remove('open');
  updateEconomies();
}

function openAddEco(id){
  const eco = state.economies.find(e=>e.id===id);
  if(!eco) return;
  document.getElementById('eco-add-id').value = id;
  document.getElementById('eco-add-name').textContent = eco.name;
  document.getElementById('eco-add-val').value = '';
  document.getElementById('eco-add-overlay').classList.add('open');
}

function confirmAddEco(){
  const id = document.getElementById('eco-add-id').value;
  const val = parseFloat(document.getElementById('eco-add-val').value)||0;
  if(val<=0){ showToast('‚ö†Ô∏è Informe um valor!'); return; }
  const idx = state.economies.findIndex(e=>e.id===id);
  if(idx>=0){ state.economies[idx].saved = (state.economies[idx].saved||0) + val; save(); }
  document.getElementById('eco-add-overlay').classList.remove('open');
  showToast('üí∞ +'+fmtMoney(val)+' guardado!');
  updateEconomies();
}

function deleteEco(id){
  const eco = state.economies.find(e=>e.id===id);
  if(!eco || !confirm('Apagar "'+eco.name+'"?')) return;
  state.economies = state.economies.filter(e=>e.id!==id);
  save(); updateEconomies();
  showToast('üóëÔ∏è Economia apagada!');
}

function updateEconomies(){
  const list = document.getElementById('eco-list');
  if(!list) return;
  const totalSaved = state.economies.reduce((s,e)=>s+(e.saved||0),0);
  const totalGoal = state.economies.reduce((s,e)=>s+(e.goal||0),0);
  const ts = document.getElementById('eco-total-saved');
  const tg = document.getElementById('eco-total-goal');
  if(ts) ts.textContent = fmtMoney(totalSaved);
  if(tg) tg.textContent = totalGoal>0?fmtMoney(totalGoal):'‚Äî';

  if(!state.economies.length){
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">üè¶</div><div>Nenhuma economia ainda.<br>Crie seu primeiro objetivo!</div></div>';
    return;
  }

  list.innerHTML = state.economies.map(eco=>{
    const cat = ECO_CAT_MAP[eco.cat]||{em:'üéØ',label:'Outros'};
    const saved = eco.saved||0;
    const goal = eco.goal||0;
    const pct = goal>0?Math.min((saved/goal)*100,100):0;
    const barColor = pct>=100?'var(--green)':pct>=70?'var(--yellow)':'var(--green)';
    const pctLabel = goal>0?pct.toFixed(0)+'%':'';
    return `<div class="eco-card">
      <div class="eco-card-top">
        <div class="eco-card-icon">${cat.em}</div>
        <div class="eco-card-info">
          <div class="eco-card-name">${eco.name}</div>
          <span class="eco-card-cat">${cat.label}</span>
          ${eco.desc?`<div style="font-size:11px;color:var(--text3);margin-top:4px">${eco.desc}</div>`:''}
        </div>
      </div>
      <div class="eco-card-vals">
        <div>
          <div style="font-size:11px;color:var(--text3)">Guardado</div>
          <div class="eco-card-saved">${fmtMoney(saved)}</div>
        </div>
        ${goal>0?`<div style="text-align:right">
          <div style="font-size:11px;color:var(--text3)">Meta</div>
          <div style="font-size:16px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--text2)">${fmtMoney(goal)}</div>
        </div>`:''}
        ${pctLabel?`<div class="eco-card-pct">${pctLabel}</div>`:''}
      </div>
      ${goal>0?`<div class="eco-bar-bg"><div class="eco-bar-fill" style="width:${pct}%;background:${barColor}"></div></div>`:''}
      <div class="eco-card-actions">
        <button class="eco-act-btn eco-act-add" onclick="openAddEco('${eco.id}')">+ Adicionar</button>
        <button class="eco-act-btn eco-act-edit" onclick="openEcoModal('${eco.id}')">‚úèÔ∏è Editar</button>
        <button class="eco-act-btn eco-act-del" onclick="deleteEco('${eco.id}')">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
}




// ===== PROCESSAR ENTRADA DO MACRODROID =====
window._processTaskerEntry = function(data, fbKey) {
  try {
    // O MacroDroid envia o texto completo da notifica√ß√£o em "desc" e "value"
    // Ex: "Ol√°, Eduardo. Voc√™ acaba de comprar R$ 22,46 em PAGUE MENOS 05. A compra foi no cr√©dito nacional..."
    const rawText = String(data.desc || data.value || '');
    
    // Extrai valor monet√°rio do texto
    const valRegex = new RegExp('R\\$\\s*([\\d.,]+)', 'i');
    const valMatch = rawText.match(valRegex);
    if (!valMatch) { console.log('Valor n√£o encontrado no texto:', rawText); return; }
    const value = parseFloat(valMatch[1].replace(/\./g,'').replace(',','.'));
    if (!value || value <= 0) return;

    // Extrai nome do estabelecimento: entre "em " e ". A compra"
    let desc = 'Compra Inter';
    const descRegex = new RegExp('em\\s+(.+?)\\s*\\.\\s*A compra', 'i');
    const descMatch = rawText.match(descRegex);
    if (descMatch) {
      desc = descMatch[1].trim().substring(0, 40);
    } else {
      const fallbackRegex = new RegExp('em\\s+([A-Z0-9\\s\\*\\-\\.]{3,40})', 'i');
      const fallback = rawText.match(fallbackRegex);
      if (fallback) desc = fallback[1].trim().substring(0, 40);
    }

    // Detecta tipo: d√©bito ou cr√©dito
    const isDebito = /d√©bit[oa]/i.test(rawText);
    
    // card_owner vem do MacroDroid (j√° identificado por cart√£o 6195)
    const cardOwner = data.card_owner || 'eduardo';
    const isPix = data.type === 'pix';
    const payment = isPix ? 'pix' : 'cartao';

    // Categoriza√ß√£o autom√°tica local
    const cat = guessCat(desc) || 'outros';

    const now = new Date();
    const tx = {
      id: Date.now() + Math.random(),
      type: 'expense',
      value: value,
      desc: desc,
      cat: cat,
      payment: payment,
      cardOwner: cardOwner,
      month: now.getMonth(),
      year: now.getFullYear(),
      day: now.getDate(),
      user: cardOwner,
      fromMacroDroid: true,
      fbQueueKey: fbKey
    };

    // Mostra modal de review (auto-importa em 15s se n√£o interagir)
    showMacroDroidReview(tx);

  } catch(e) { console.error('Tasker entry error:', e); }
};

// ===== FIREBASE SYNC =====
window._currentUser = 'eduardo';
window._syncFromFirebase = function(incoming) {
  // Merge incoming with local, avoiding duplicates by id
  const localIds = new Set(state.transactions.map(t=>String(t.id)));
  let changed = false;
  incoming.forEach(tx => {
    if (!localIds.has(String(tx.id))) {
      state.transactions.push(tx);
      changed = true;
    }
  });
  // Remove local txs that were deleted remotely
  const remoteIds = new Set(incoming.map(t=>String(t.id)));
  const before = state.transactions.length;
  state.transactions = state.transactions.filter(t=>!t.fbId||remoteIds.has(String(t.id)));
  if (state.transactions.length !== before) changed = true;
  if (changed) { save(); if(currentScreen==='home')updateHome(); if(currentScreen==='cartao')updateCard(); if(currentScreen==='historico')updateHistory(); }
};

// ===== NOTIFICATION BANNER =====
let notifTimeout = null;
window._showNotifBanner = function(msg, from) {
  const who = from === 'eduardo' ? 'üë®üèæ Eduardo' : 'üë©üèæ Juliana';
  document.getElementById('notif-icon').textContent = from === 'eduardo' ? 'üë®üèæ' : 'üë©üèæ';
  document.getElementById('notif-who').textContent = who + ' lan√ßou um gasto!';
  document.getElementById('notif-msg').textContent = msg;
  const banner = document.getElementById('notif-banner');
  banner.classList.add('show');
  clearTimeout(notifTimeout);
  notifTimeout = setTimeout(() => banner.classList.remove('show'), 6000);
  // Browser notification if allowed
  if (Notification && Notification.permission === 'granted') {
    new Notification(who + ' lan√ßou um gasto!', { body: msg, icon: 'üíö' });
  }
};
function closeNotifBanner() { document.getElementById('notif-banner').classList.remove('show'); }

// Request browser notification permission on login
function requestNotifPermission() {
  if (Notification && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}

// ===== EDIT TRANSACTION =====
let editingTx = null;
function openEdit(t) {
  editingTx = t;
  document.getElementById('edit-value').value = t.value;
  document.getElementById('edit-desc').value = t.desc;
  document.getElementById('edit-tx-id').value = t.id;
  document.getElementById('edit-payment').value = t.payment || 'pix';
  // Build cat grid
  const grid = document.getElementById('edit-cat-grid');
  grid.innerHTML = CATS.map(c=>`<div class="cat-option${c.id===t.cat?' selected':''}" onclick="selectEditCat(this,'${c.id}')"><span class="cat-em">${c.em}</span>${c.label}</div>`).join('');
  document.getElementById('edit-overlay').classList.add('open');
}
function selectEditCat(el,cat){
  document.querySelectorAll('#edit-cat-grid .cat-option').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  editingTx._editCat = cat;
}
function closeEditOutside(e){if(e.target===document.getElementById('edit-overlay'))document.getElementById('edit-overlay').classList.remove('open');}
function saveEdit() {
  if (!editingTx) return;
  const newVal = parseFloat(document.getElementById('edit-value').value);
  const newDesc = document.getElementById('edit-desc').value.trim();
  const newCat = editingTx._editCat || document.querySelector('#edit-cat-grid .cat-option.selected')?.dataset?.cat || editingTx.cat;
  const newPayment = document.getElementById('edit-payment').value;
  if (!newVal||newVal<=0){showToast('‚ö†Ô∏è Informe um valor!');return;}
  if (!newDesc){showToast('‚ö†Ô∏è Informe uma descri√ß√£o!');return;}
  // Update local
  const idx = state.transactions.findIndex(t=>String(t.id)===String(editingTx.id));
  if (idx>=0) {
    const oldPayment = state.transactions[idx].payment;
    const oldVal = state.transactions[idx].value;
    const oldCO=state.transactions[idx].cardOwner||state.transactions[idx].user||currentUser;
    if (oldPayment==='cartao'&&state.cards[oldCO])state.cards[oldCO].used-=oldVal;
    state.transactions[idx]={...state.transactions[idx],value:newVal,desc:newDesc,cat:newCat,payment:newPayment};
    if (newPayment==='cartao'){const nco=state.transactions[idx].cardOwner||currentUser;if(state.cards[nco])state.cards[nco].used+=newVal;}
    save();
    // Update Firebase
    if (window._firebaseReady && editingTx.fbId) {
      window._updateInFirebase(editingTx.fbId, {value:newVal, desc:newDesc, cat:newCat, payment:newPayment});
    }
  }
  document.getElementById('edit-overlay').classList.remove('open');
  showToast('‚úÖ Lan√ßamento atualizado!');
  updateHome(); if(currentScreen==='cartao')updateCard();
}
function confirmDelete() {
  if (!editingTx) return;
  if (!confirm(`Apagar "${editingTx.desc}" de ${fmtMoney(editingTx.value)}?`)) return;
  deleteTx(editingTx);
  document.getElementById('edit-overlay').classList.remove('open');
}
function deleteTx(t) {
  if (!confirm(`Apagar "${t.desc}" de ${fmtMoney(t.value)}?`)) return;
  const idx = state.transactions.findIndex(tx=>String(tx.id)===String(t.id));
  if (idx>=0) {
    if (state.transactions[idx].payment==='cartao'){const co=state.transactions[idx].cardOwner||state.transactions[idx].user||currentUser;if(state.cards[co])state.cards[co].used-=state.transactions[idx].value;}
    // Remove pet expense too
    if (t.pet && state.pets[t.pet]) {
      state.pets[t.pet].expenses = state.pets[t.pet].expenses.filter(e=>!(e.desc===t.desc&&e.value===t.value));
    }
    state.transactions.splice(idx,1);
    save();
    if (window._firebaseReady && t.fbId) window._removeFromFirebase(t.fbId);
  }
  showToast('üóëÔ∏è Lan√ßamento apagado!');
  updateHome(); if(currentScreen==='cartao')updateCard(); if(currentScreen==='pets')updatePets();
}

function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);}
function fmtMoney(v){return'R$ '+Math.abs(v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fileToBase64(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.onerror=()=>rej(new Error('Erro'));r.readAsDataURL(file);});}

document.getElementById('month-label').textContent=MONTHS[currentMonth]+' '+currentYear;
</script>

<!-- NOTIFICATION BANNER -->
<div class="notif-banner" id="notif-banner">
  <div class="notif-icon" id="notif-icon">üí∏</div>
  <div class="notif-text">
    <strong id="notif-who"></strong>
    <p id="notif-msg"></p>
  </div>
  <button class="notif-close" onclick="closeNotifBanner()">‚úï</button>
</div>

<!-- EDIT TRANSACTION MODAL -->
<div class="modal-overlay" id="edit-overlay" onclick="closeEditOutside(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>‚úèÔ∏è Editar Lan√ßamento</h2>
    <div class="form-group"><label class="form-label">Valor (R$)</label><input class="form-input big" type="number" id="edit-value" placeholder="0,00"></div>
    <div class="form-group"><label class="form-label">Descri√ß√£o</label><input class="form-input" type="text" id="edit-desc"></div>
    <div class="form-group"><label class="form-label">Categoria</label><div class="cat-grid" id="edit-cat-grid"></div></div>
    <div class="form-group"><label class="form-label">Pago com</label>
      <select class="form-input" id="edit-payment">
        <option value="pix">üíµ Dinheiro / Pix</option>
        <option value="cartao">üí≥ Cart√£o Inter</option>
        <option value="debito">üí≥ D√©bito</option>
      </select>
    </div>
    <input type="hidden" id="edit-tx-id">
    <button class="btn-primary" onclick="saveEdit()" style="margin-bottom:10px">üíæ Salvar Altera√ß√µes</button>
    <button class="btn-danger" onclick="confirmDelete()">üóëÔ∏è Apagar este lan√ßamento</button>
  </div>
</div>


<!-- BANNER INSTALAR APP (Android/Chrome) -->
<div id="install-banner" style="display:none;position:fixed;bottom:90px;left:50%;transform:translateX(-50%);width:calc(100% - 32px);max-width:398px;background:linear-gradient(135deg,#1a3a2a,#0d2218);border:1px solid var(--green);border-radius:20px;padding:16px 18px;z-index:400;align-items:center;gap:12px;box-shadow:0 8px 32px rgba(0,0,0,0.5);">
  <span style="font-size:32px">üíö</span>
  <div style="flex:1">
    <div style="font-size:14px;font-weight:700;color:var(--green-light)">Instalar o App!</div>
    <div style="font-size:11px;color:var(--text2);margin-top:2px">Adicione √† tela inicial para usar como app nativo</div>
  </div>
  <button onclick="installApp()" style="background:var(--green);border:none;color:#0a0f0d;padding:8px 14px;border-radius:10px;font-family:'Sora',sans-serif;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap">Instalar</button>
  <button onclick="closeInstallBanner()" style="background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer;padding:4px">‚úï</button>
</div>

<!-- BANNER INSTALAR APP (iOS/Safari) -->
<div id="ios-install-banner" style="display:none;position:fixed;bottom:90px;left:50%;transform:translateX(-50%);width:calc(100% - 32px);max-width:398px;background:linear-gradient(135deg,#1a3a2a,#0d2218);border:1px solid var(--green);border-radius:20px;padding:16px 18px;z-index:400;flex-direction:column;gap:10px;box-shadow:0 8px 32px rgba(0,0,0,0.5);">
  <div style="display:flex;align-items:center;gap:10px">
    <span style="font-size:28px">üíö</span>
    <div style="flex:1"><div style="font-size:14px;font-weight:700;color:var(--green-light)">Instalar no iPhone</div></div>
    <button onclick="document.getElementById('ios-install-banner').style.display='none'" style="background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer">‚úï</button>
  </div>
  <div style="font-size:12px;color:var(--text2);line-height:1.6">
    Toque em <strong style="color:var(--text)">‚¨ÜÔ∏è Compartilhar</strong> no Safari e depois em <strong style="color:var(--text)">"Adicionar √† Tela de In√≠cio"</strong> para instalar o app.
  </div>
</div>

<!-- ===== PWA: INSTALL PROMPT + SERVICE WORKER ===== -->
<script>
// Captura o evento de instala√ß√£o
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  // Mostra o banner de instala√ß√£o ap√≥s login
  showInstallBanner();
});

function showInstallBanner() {
  const banner = document.getElementById('install-banner');
  if (banner && deferredPrompt) {
    banner.style.display = 'flex';
  }
}

async function installApp() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById('install-banner').style.display = 'none';
  if (result.outcome === 'accepted') {
    showToast('‚úÖ App instalado com sucesso!');
  }
}

function closeInstallBanner() {
  document.getElementById('install-banner').style.display = 'none';
}

// iOS: n√£o tem beforeinstallprompt, detecta manualmente
function isIOS() {
  return /iphone|ipad|ipod/i.test(navigator.userAgent);
}
function isInStandaloneMode() {
  return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
}

window.addEventListener('load', () => {
  if (isIOS() && !isInStandaloneMode()) {
    setTimeout(() => {
      const banner = document.getElementById('ios-install-banner');
      if (banner) banner.style.display = 'flex';
    }, 3000);
  }
});

// Service Worker - registra sw.js se existir (GitHub Pages)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('‚úÖ Service Worker registrado!'))
      .catch(() => console.log('SW n√£o dispon√≠vel (modo local ok)'));
  });
}
</script>

<!-- MANIFEST JSON inline via link (GitHub Pages precisa do arquivo separado)
     Mas tamb√©m injetamos via JS para funcionar sem arquivo separado -->
<script>
(function() {
  const manifest = {
    name: "Financeiro do Casal üíö",
    short_name: "Financeiro",
    description: "Controle financeiro Eduardo & Juliana",
    start_url: "./financeiro-casal.html",
    display: "standalone",
    background_color: "#0a0f0d",
    theme_color: "#0a0f0d",
    orientation: "portrait",
    icons: [
      {
        src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='100' fill='%230a0f0d'/><text y='.85em' font-size='400' x='56'>üíö</text></svg>",
        sizes: "512x512",
        type: "image/svg+xml",
        purpose: "any maskable"
      }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
  const url = URL.createObjectURL(blob);
  // Update or create manifest link
  let link = document.querySelector('link[rel="manifest"]');
  if (!link) { link = document.createElement('link'); link.rel = 'manifest'; document.head.appendChild(link); }
  link.href = url;
})();
</script>

<!-- ===== MACRODROID INTEGRATION ===== -->
<script>
// Regex patterns para notifica√ß√µes do Inter
// Testados com formatos reais do app Inter
const INTER_PATTERNS = [
  // Formato: "Compra no credito - iFood* 47392 R$ 42,90"
  /R\$\s*([\d.,]+)/i,
];

// Extrair valor de texto da notifica√ß√£o
function extractValue(text) {
  const match = text.match(new RegExp('R\\$\\s*([\\d.,]+)', 'i'));
  if (!match) return null;
  return parseFloat(match[1].replace(/\./g,'').replace(',','.'));
}

// Extrair descri√ß√£o limpando c√≥digo do Inter
function extractDesc(text) {
  // Remove "R$ XX,XX", "Cart√£o final XXXX", prefixos comuns
  let desc = text
    .replace(/compra no cr√©dito/gi,'')
    .replace(/compra aprovada/gi,'')
    .replace(/cr√©dito aprovado/gi,'')
    .replace(/d√©bito aprovado/gi,'')
    .replace(/R\$\s*[\d.,]+/gi,'')
    .replace(/cart√£o.*?(\d{4})/gi,'')
    .replace(/\*\d+/g,'')  // remove c√≥digos tipo "iFood* 47392"
    .replace(/\s+/g,' ')
    .trim();
  return desc.slice(0,40) || 'Compra Inter';
}

// Identificar dono pelo texto (Eduardo ou Juliana)
function extractOwner(text) {
  const t = text.toLowerCase();
  if (t.includes('juliana')) return 'juliana';
  if (t.includes('eduardo')) return 'eduardo';
  return 'eduardo'; // padr√£o: titular
}

// Processar push vindo do MacroDroid via Firebase
window._processMacroDroidPush = function(data) {
  console.log('üì± MacroDroid push recebido:', data);
  const text = (data.title||'') + ' ' + (data.text||'') + ' ' + (data.subtext||'');
  const value = extractValue(text);
  if (!value || value <= 0) { console.log('Valor n√£o encontrado, ignorando'); return; }
  const desc = data.desc || extractDesc(text);
  const owner = data.owner || extractOwner(text);
  const cat = guessCat(desc) || 'outros';
  const now = new Date();
  const tx = {
    id: Date.now() + Math.random(),
    type: 'expense',
    value,
    desc,
    cat,
    payment: 'cartao',
    cardOwner: owner,
    month: now.getMonth(),
    year: now.getFullYear(),
    day: now.getDate(),
    user: owner,
    fromMacroDroid: true,
    autoCapture: true,
  };
  // Mostrar modal de review (n√£o importa direto, d√° chance de corrigir)
  showMacroDroidReview(tx);
};

// Modal de review: aparece quando MacroDroid envia uma compra
function showMacroDroidReview(tx) {
  const cat = CAT_MAP[tx.cat] || {em:'üì¶', label:tx.cat};
  const ownerName = tx.cardOwner === 'eduardo' ? 'Eduardo' : 'Juliana';
  const partnerName = tx.cardOwner === 'eduardo' ? 'Juliana' : 'Eduardo';

  document.getElementById('md-review-desc').textContent = tx.desc;
  document.getElementById('md-review-val').textContent = fmtMoney(tx.value);
  document.getElementById('md-review-owner').textContent = 'üë§ ' + ownerName;
  document.getElementById('md-review-cat-em').textContent = cat.em;
  document.getElementById('md-review-cat-label').textContent = cat.label;

  // Build cat grid
  const grid = document.getElementById('md-cat-grid');
  grid.innerHTML = CATS.map(c =>
    `<div class="cat-option${c.id===tx.cat?' selected':''}" onclick="selectMDCat(this,'${c.id}')">
      <span class="cat-em">${c.em}</span>${c.label}
    </div>`
  ).join('');

  // Toggle owner button
  document.getElementById('md-toggle-owner').textContent = '‚ÜîÔ∏è Mover para ' + partnerName;
  document.getElementById('md-toggle-owner').onclick = () => {
    tx.cardOwner = tx.cardOwner === 'eduardo' ? 'juliana' : 'eduardo';
    tx.user = tx.cardOwner;
    showMacroDroidReview(tx); // re-render
  };

  // Confirm button
  document.getElementById('md-confirm-btn').onclick = () => {
    const selectedCatEl = document.querySelector('#md-cat-grid .cat-option.selected');
    if (selectedCatEl) {
      const selCat = CATS[Array.from(document.querySelectorAll('#md-cat-grid .cat-option')).indexOf(selectedCatEl)];
      if(selCat) tx.cat = selCat.id;
    }
    importMacroDroidTx(tx);
    document.getElementById('md-review-overlay').classList.remove('open');
  };

  // Skip button
  document.getElementById('md-skip-btn').onclick = () => {
    document.getElementById('md-review-overlay').classList.remove('open');
    showToast('‚è≠Ô∏è Lan√ßamento ignorado');
  };

  document.getElementById('md-review-overlay').classList.add('open');

  // Notifica√ß√£o do browser se app n√£o estiver em foco
  if (Notification && Notification.permission === 'granted' && document.hidden) {
    new Notification('üì± Nova compra detectada!', {
      body: tx.desc + ' ¬∑ ' + fmtMoney(tx.value) + ' ¬∑ ' + (tx.cardOwner === 'eduardo' ? 'Eduardo' : 'Juliana'),
      icon: 'üíö',
      tag: 'macrodroid-review'
    });
  }

  // Auto-import after 15s if user doesn't interact
  clearTimeout(window._mdAutoTimer);
  window._mdAutoTimer = setTimeout(() => {
    if (document.getElementById('md-review-overlay').classList.contains('open')) {
      importMacroDroidTx(tx);
      document.getElementById('md-review-overlay').classList.remove('open');
      showToast('‚úÖ Auto-importado: ' + tx.desc);
    }
  }, 15000);
}

function selectMDCat(el, cat) {
  document.querySelectorAll('#md-cat-grid .cat-option').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
}

function importMacroDroidTx(tx) {
  state.cards[tx.cardOwner].used += tx.value;
  state.transactions.push(tx);
  save();
  if (window._firebaseReady) window._pushToFirebase(tx);
  // Notify partner
  const who = tx.cardOwner === 'eduardo' ? 'Eduardo' : 'Juliana';
  const partner = tx.cardOwner === 'eduardo' ? 'juliana' : 'eduardo';
  window._sendNotification(partner, `üí≥ ${who} gastou ${fmtMoney(tx.value)} em ${tx.desc}`, tx.cardOwner);
  showToast('‚úÖ ' + tx.desc + ' ¬∑ ' + fmtMoney(tx.value));
  updateHome(); updateCard();
}
</script>

<!-- MODAL REVIEW MACRODROID -->
<div class="modal-overlay" id="md-review-overlay">
  <div class="modal" style="border-color:rgba(46,204,113,0.4)">
    <div class="modal-handle"></div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
      <span style="font-size:24px">üì±</span>
      <h2 style="margin:0;font-size:18px">Nova compra detectada!</h2>
      <span style="margin-left:auto;font-size:11px;color:var(--text3);background:var(--bg3);padding:4px 8px;border-radius:99px">Auto ¬∑ Inter</span>
    </div>
    <p style="font-size:12px;color:var(--text2);margin-bottom:16px">MacroDroid capturou uma compra. Confirme ou ajuste antes de importar.</p>

    <!-- Resumo -->
    <div style="background:var(--bg3);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px">
      <div style="font-size:18px;font-weight:700;margin-bottom:4px" id="md-review-desc">‚Äî</div>
      <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--red-light)" id="md-review-val">‚Äî</div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <span style="font-size:13px;background:var(--green-glow);color:var(--green);padding:4px 10px;border-radius:99px">
          <span id="md-review-cat-em"></span> <span id="md-review-cat-label"></span>
        </span>
        <span style="font-size:13px;background:rgba(52,152,219,0.12);color:#3498db;padding:4px 10px;border-radius:99px" id="md-review-owner"></span>
      </div>
    </div>

    <!-- Categoria -->
    <div class="form-group">
      <label class="form-label">Ajustar categoria</label>
      <div class="cat-grid" id="md-cat-grid"></div>
    </div>

    <!-- Trocar dono -->
    <button id="md-toggle-owner" style="width:100%;background:rgba(52,152,219,0.1);border:1px solid rgba(52,152,219,0.3);color:#3498db;padding:11px;border-radius:10px;font-family:'Sora',sans-serif;font-size:13px;font-weight:600;cursor:pointer;margin-bottom:12px">‚ÜîÔ∏è Mover para Juliana</button>

    <!-- Bot√µes -->
    <button class="btn-primary" id="md-confirm-btn" style="margin-bottom:8px">‚úÖ Confirmar e importar</button>
    <button id="md-skip-btn" style="width:100%;background:none;border:1px solid var(--border);color:var(--text2);padding:11px;border-radius:10px;font-family:'Sora',sans-serif;font-size:13px;cursor:pointer">‚è≠Ô∏è Ignorar esta compra</button>
    <p style="font-size:11px;color:var(--text3);text-align:center;margin-top:10px">‚è±Ô∏è Importado automaticamente em 15 segundos se n√£o interagir</p>
  </div>
</div>

</body>
</html>
